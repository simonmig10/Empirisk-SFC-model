---
title: "The real model"
author: "Simon"
date: "27/6/2022"
output: html_document
---

# Packages

```{r}
library(tstools)
```


# Import data

```{r}
AAMK <- read_excel("AAMK.xlsx")

names(AAMK) <- tolower(names(AAMK))

AAMK=lapply(AAMK, function(t) ts(t, start=c(2005, 2), end=c(2020, 1),frequency=4))
attach(AAMK)
```



```{r}
eq_nf_l_nf = res_eq_nf_l
eq_f_l_f = res_eq_f_l
```


# PARAMETERS

## Create dummies


```{r}
d_2006q1=create_dummy_ts(start_basic = c(2005, 2), end_basic=c(2020,1),
 dummy_start=c(2006,1), dummy_end = c(2006,1),
 basic_value = 0, dummy_value = 1, frequency = 4)

d_2006q2=create_dummy_ts(start_basic = c(2005, 2), end_basic=c(2020,1),
 dummy_start=c(2006,2), dummy_end = c(2006,2),
 basic_value = 0, dummy_value = 1, frequency = 4)

d_2006q3=create_dummy_ts(start_basic = c(2005, 2), end_basic=c(2020,1),
 dummy_start=c(2006,3), dummy_end = c(2006,3),
 basic_value = 0, dummy_value = 1, frequency = 4)

d_2006q4=create_dummy_ts(start_basic = c(2005, 2), end_basic=c(2020,1),
 dummy_start=c(2006,4), dummy_end = c(2006,4),
 basic_value = 0, dummy_value = 1, frequency = 4)

d_2007q34=create_dummy_ts(start_basic = c(2005, 2), end_basic=c(2020,1),
 dummy_start=c(2007,3), dummy_end = c(2007,4),
 basic_value = 0, dummy_value = 1, frequency = 4)

d_2008q2=create_dummy_ts(start_basic = c(2005, 2), end_basic=c(2020,1),
 dummy_start=c(2008,2), dummy_end = c(2008,2),
 basic_value = 0, dummy_value = 1, frequency = 4)

d_2008q3=create_dummy_ts(start_basic = c(2005, 2), end_basic=c(2020,1),
 dummy_start=c(2008,3), dummy_end = c(2008,3),
 basic_value = 0, dummy_value = 1, frequency = 4)

d_2008q4=create_dummy_ts(start_basic = c(2005, 2), end_basic=c(2020,1),
 dummy_start=c(2008,4), dummy_end = c(2008,4),
 basic_value = 0, dummy_value = 1, frequency = 4)

d_2009q4=create_dummy_ts(start_basic = c(2005, 2), end_basic=c(2020,1),
 dummy_start=c(2009,4), dummy_end = c(2009,4),
 basic_value = 0, dummy_value = 1, frequency = 4)

d_2018q2=create_dummy_ts(start_basic = c(2005, 2), end_basic=c(2020,1),
 dummy_start=c(2018,2), dummy_end = c(2018,2),
 basic_value = 0, dummy_value = 1, frequency = 4)

##### Er der noget specielt med dem her?????

d_20123=create_dummy_ts(start_basic = c(2005, 2), end_basic=c(2020,1),
 dummy_start=c(2012,3), dummy_end = c(2012,3),
 basic_value = 0, dummy_value = 1, frequency = 4)

d_20124=create_dummy_ts(start_basic = c(2005, 2), end_basic=c(2020,1),
 dummy_start=c(2012,4), dummy_end = c(2012,4),
 basic_value = 0, dummy_value = 1, frequency = 4)

#### Videre igen 

d_2009q1=create_dummy_ts(start_basic = c(2005, 2), end_basic=c(2020,1),
 dummy_start=c(2009,1), dummy_end = c(2009,1),
 basic_value = 0, dummy_value = 1, frequency = 4)

d_2011q1=create_dummy_ts(start_basic = c(2005, 2), end_basic=c(2020,1),
 dummy_start=c(2011,1), dummy_end = c(2011,1),
 basic_value = 0, dummy_value = 1, frequency = 4)

d_2014q3=create_dummy_ts(start_basic = c(2005, 2), end_basic=c(2020,1),
 dummy_start=c(2014,3), dummy_end = c(2014,3),
 basic_value = 0, dummy_value = 1, frequency = 4)

d_2014q4=create_dummy_ts(start_basic = c(2005, 2), end_basic=c(2020,1),
 dummy_start=c(2014,4), dummy_end = c(2014,4),
 basic_value = 0, dummy_value = 1, frequency = 4)

d_2013q4=create_dummy_ts(start_basic = c(2005, 2), end_basic=c(2020,1),
 dummy_start=c(2013,4), dummy_end = c(2013,4),
 basic_value = 0, dummy_value = 1, frequency = 4)

d_2018q1=create_dummy_ts(start_basic = c(2005, 2), end_basic=c(2020,1),
 dummy_start=c(2018,1), dummy_end = c(2018,1),
 basic_value = 0, dummy_value = 1, frequency = 4)

d_2016q3=create_dummy_ts(start_basic = c(2005, 2), end_basic=c(2020,1),
 dummy_start=c(2016,3), dummy_end = c(2016,3),
 basic_value = 0, dummy_value = 1, frequency = 4)

d_2019q3=create_dummy_ts(start_basic = c(2005, 2), end_basic=c(2020,1),
 dummy_start=c(2019,3), dummy_end = c(2019,3),
 basic_value = 0, dummy_value = 1, frequency = 4)

d_2019q4=create_dummy_ts(start_basic = c(2005, 2), end_basic=c(2020,1),
 dummy_start=c(2019,4), dummy_end = c(2019,4),
 basic_value = 0, dummy_value = 1, frequency = 4)

d_2020q1=create_dummy_ts(start_basic = c(2005, 2), end_basic=c(2020,1),
 dummy_start=c(2020,1), dummy_end = c(2020,1),
 basic_value = 0, dummy_value = 1, frequency = 4)

```


# Variables 

## Real Variables 

```{r}
pc = pc/100
px = px/100
pi = pi/100
pg= pg/100
pm = pm/100
py = py/100
pf = pc*xr/rer
rer = pc*xr/pf
pconk = pcon/pc
gk = g/pg
xk = x/px
mk = m/pm
```



```{r}

i_adj_h = i_h -  (i_equip_h + i_bd_h)
i_adj_nfc = i_nf - (i_equip_nfc + i_bd_nfc)
i_adj_fc = i_f - (i_equip_fc + i_bd_fc)
i_adj_g = i_g - (i_equip_g +i_bd_g)
```

```{r}
i_equip_h_k = i_equip_h/p_equip
i_equip_nfc_k =  i_equip_nfc/p_equip
i_equip_g_k = i_equip_g/p_equip
i_equip_fc_k =  i_equip_fc/p_equip
```


```{r}
i_bd_h_k =  i_bd_h/p_bd
i_bd_nfc_k =  i_bd_nfc/p_bd
i_bd_g_k =  i_bd_g/p_bd
i_bd_fc_k =  i_bd_fc/p_bd
```


I just deflate the adjustment terms using p_equip as well (assuming most of it is changes in inventories)

```{r}
i_adj_h_k = i_adj_h /p_equip
i_adj_nfc_k = i_adj_nfc /p_equip
i_adj_fc_k = i_adj_fc /p_equip
i_adj_g_k = i_adj_g /p_equip
```

we can compare ik with ikk. just to make sure we have all components of investment.

-- Ved ik om "ik" og "ikk" skal give det samme men gør de ik --

```{r}
ik =  i_equip_h_k + i_equip_nfc_k  +  i_equip_g_k + i_equip_fc_k +  i_bd_h_k + i_bd_nfc_k  +  i_bd_g_k  + i_bd_fc_k + i_adj_h_k + i_adj_nfc_k + i_adj_fc_k + i_adj_g_k

ikk = i/pi


cbind(ik, ikk) # spg Mikael
```



```{r}
yk = ik + pconk + gk + xk - mk
```

```{r}

npropinc_h = propinc_r_h - propinc_p_h
nsben_h = sben_h_r - scon_h_p
```

```{r}
iba_f = - (iba_h + iba_nf + iba_g + iba_row) # The data from the database is not consistent (the sum of the stocks of IBA does not add up to zero). I fix it by assuming that iba_f is entirely demand-led.

iba_f_tr = - (iba_h_tr + iba_nf_tr + iba_g_tr + iba_row_tr) #The data from the database is not consistent (the sum of IBA transactions does not add up to zero). I fix it by assuming that iba_f_tr is entirely demand-led.
```


```{r}
### Jeg tager bare og fjerner første observation fra dem der er minuse så den først starer i 2005q3

iba_h_rvx=diff(iba_h)-iba_h_tr[-1]
iba_f_rvx=diff(iba_f)-iba_f_tr[-1]
iba_nf_rvx=diff(iba_nf)-iba_nf_tr[-1]
iba_g_rvx=diff(iba_g)-iba_g_tr[-1]
iba_row_rvx=diff(iba_row)-iba_row_tr[-1]
```


```{r}
eq_h = - ((eq_f_a - eq_f_l) + (eq_nf_a - eq_nf_l) + eq_g + (eq_row_a - eq_row_l)) #The data from the database is not consistent (the sum of the stocks of equities does not add up to zero). I fix it by assuming that eq_h absorbbs the small discrepancies that come from the database.
```


```{r}
### Der ages diff så de sarer alle i 2005Q3

eq_h_rvx=diff(eq_h)-eq_h_tr[-1]
eq_f_a_rvx=diff(eq_f_a)-eq_f_a_tr[-1]
eq_f_l_rvx=diff(eq_f_l)-eq_f_l_tr[-1]
eq_nf_a_rvx=diff(eq_nf_a)-eq_nf_a_tr[-1]
eq_nf_l_rvx=diff(eq_nf_l)-eq_nf_l_tr[-1]
eq_g_rvx=diff(eq_g)-eq_g_tr[-1]
eq_row_a_rvx=diff(eq_row_a)-eq_row_a_tr[-1]
eq_row_l_rvx=diff(eq_row_l)-eq_row_l_tr[-1]
```


```{r}

### Tror også alle disse starer i 2005Q3

Neq_row = eq_row_a - eq_row_l 
Neq_nf = eq_nf_a - eq_nf_l 
Neq_f = eq_f_a - eq_f_l 
Neq_nf_rvx = eq_nf_a_rvx-eq_nf_l_rvx
Neq_f_rvx = eq_f_a_rvx-eq_f_l_rvx
Neq_row_rvx = eq_row_a_rvx-eq_row_l_rvx
Neq_nf_tr = diff(Neq_nf)-(Neq_nf_rvx)
Neq_f_tr = diff(Neq_f)-(Neq_f_rvx)
alpha_neq_nf = -Neq_nf/i_nf
Neq_row_tr = diff(Neq_row) - Neq_row_rvx
```

```{r}
# Igen starter førsst i 2005Q3

eq_h_tr = - (Neq_nf_tr  + Neq_f_tr + eq_g_tr[-1] + Neq_row_tr) # The data from the database is not consistent (the sum of the stocks of equities does not add up to zero). I fix it by assuming that eq_h_tr absorbbs the small discrepancies that come from the database.
```

```{r}
eq_f_l_rvx = diff(eq_f_l)-eq_f_l_tr[-1]
eq_nf_l_rvx = diff(eq_nf_l)-eq_nf_l_tr[-1]
eq_row_l_rvx = diff(eq_row_l)-eq_row_l_tr[-1]

```

```{r}
ins_f = - (ins_row + ins_h + ins_nf + ins_g) # The database is almost consistent, but I redifine ins_f to make it fully consistent and avoid carrying discrepancies along when running the simulations.
ins_f_tr = - (ins_row_tr + ins_h_tr + ins_nf_tr + ins_g_tr) # The database is almost consistent, but I redifine ins_f_tr to make it fully consistent and avoid carrying discrepancies along when running the simulations.
```


```{r}

## Samme som før 2005Q3
ins_h_rvx=diff(ins_h)-ins_h_tr[-1]
ins_f_rvx=diff(ins_f)-ins_f_tr[-1]
ins_nf_rvx=diff(ins_nf)-ins_nf_tr[-1]
ins_g_rvx=diff(ins_g)-ins_g_tr[-1]
ins_row_rvx=diff(ins_row)-ins_row_tr[-1]
```

```{r}
sec_g = - (sec_row + sec_h + sec_f_a + sec_f_d + sec_nf) # The database is almost consistent, but I redifine sec_g to make it fully consistent and avoid carrying discrepancies along when running the simulations.
sec_g_tr = - (sec_row_tr + sec_h_tr + sec_f_a_tr + sec_f_d_tr + sec_nf_tr) # The database is almost consistent, but I redifine sec_g to make it fully consistent and avoid carrying discrepancies along when running the simulations.
```

```{r}
sec_h_rvx=diff(sec_h)-sec_h_tr[-1]
sec_f_a_rvx=diff(sec_f_a)-sec_f_a_tr[-1]
sec_f_d_rvx=diff(sec_f_d)-sec_f_d_tr[-1]
sec_nf_rvx=diff(sec_nf)-sec_nf_tr[-1]
sec_g_rvx=diff(sec_g)-sec_g_tr[-1]
sec_row_rvx=diff(sec_row)-sec_row_tr[-1]
```

```{r}
l_f = - (l_h + l_nf + l_g + l_row) # The database is almost consistent, but I redifine l_f to make it fully consistent and avoid carrying discrepancies along when running the simulations.
l_f_tr = - (l_h_tr + l_nf_tr + l_g_tr + l_row_tr) # The database is almost consistent, but I redifine l_f to make it fully consistent and avoid carrying discrepancies along when running the simulations.
```

```{r}
l_h_rvx=diff(l_h)-l_h_tr[-1]
l_f_rvx=diff(l_f)-l_f_tr[-1]
l_nf_rvx=diff(l_nf)-l_nf_tr[-1]
l_g_rvx=diff(l_g)-l_g_tr[-1]
l_row_rvx=diff(l_row)-l_row_tr[-1]
```

```{r}
int_nf_adj = (int_r_nf - int_p_nf) - (stats::lag(idep,n=1)*stats::lag(iba_nf,1) + stats::lag(ibd,1)*stats::lag(sec_nf,1) + stats::lag(iloan,1)*stats::lag(l_nf,1))

int_h_adj = (int_r_h - int_p_h) - (stats::lag(idep,n=1)*stats::lag(iba_h,1) + stats::lag(ibd,1)*stats::lag(sec_h,1) + stats::lag(iloan,1)*stats::lag(l_h,1)) # this calculation calculates the discrepancy for interest payments as net flow.
```

```{r}
#Below I (hamid) compute discrepancy between interest payments and reciepts separately to create a measure of propert income (paid and recieved) instead of just using net property income (npropinc) in the model

int_r_h_adj = int_r_h  - (stats::lag(idep,1)*stats::lag(iba_h,1)  + stats::lag(ibd,1)*stats::lag(sec_h,1))

int_p_h_adj = int_p_h  + stats::lag(iloan,1)*stats::lag(l_h,1)
```


```{r}
#For the rest of the sectors, we just calculate the discrepancies based on net asset holding
int_g_adj = (int_r_g - int_p_g) - (stats::lag(idep,1)*stats::lag(iba_g,1) + stats::lag(iloan,1)*stats::lag(l_g,1) + stats::lag(ibd,1)*stats::lag(sec_g,1))

int_row_adj = (int_r_row - int_p_row) - (stats::lag(idep,1)*stats::lag(iba_row,1) + stats::lag(iboa,1)*stats::lag(sec_row,1) + stats::lag(iloan,1)*stats::lag(l_row,1))


int_f_adj = (int_r_f - int_p_f) - (stats::lag(idep,1)*stats::lag(iba_f,1) + stats::lag(iloan,1)*stats::lag(l_f,1) + stats::lag(ibd,1)*stats::lag(sec_f_d,1) + stats::lag(iboa,1)*stats::lag(sec_f_a,1))
```

```{r}
test = int_nf_adj  + int_h_adj  + int_g_adj  + int_f_adj  + int_row_adj
```


Below we create series for equities viz-a-viz counterparties. The data is only available from 2012 onwards so we use the porportion w.r.t to the aggregate payments to create data back in time (because we have aggregate data)


```{r}


alpha_nf_rv = eq_h_nf_rv[31:60]/(eq_h_nf_rv[31:60] + eq_h_f_rv[31:60] + eq_h_row_rv[31:60]) ## mean of alpha is 0.57 (excluding the spike in the start of the sample somwhere 2013q3 (not sure about the exact point))
alpha_f_rv = eq_h_f_rv[31:60]/(eq_h_nf_rv[31:60] + eq_h_f_rv[31:60] + eq_h_row_rv[31:60]) #  mean of alpha is 0.37 (excluding the spike in the start of the sample somwhere 2013q3 (not sure about the exact point))
alpha_row_rv = eq_h_row_rv[31:60]/(eq_h_nf_rv[31:60] + eq_h_f_rv[31:60] + eq_h_row_rv[31:60]) # mean of alpha is 0.06 (excluding the spike in the start of the sample somwhere 2013q3 (not sure about the exact point))
```


dummies for equity revaluation equations

```{r}
#dummy_1=create_dummy_ts(start_basic = c(2005, 1), end_basic=c(2020,1),
 #dummy_start=c(2005,2), dummy_end = c(2012,4),
 ##basic_value = 0, dummy_value = 1, frequency = 4)

dummy_1=ts(c(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0), start = c(2005, 2), end = c(2020,1), frequency = 4)

dummy_2=create_dummy_ts(start_basic = c(2005, 2), end_basic=c(2020,1),
 dummy_start=c(2013,1), dummy_end = c(2020,1),
 basic_value = 0, dummy_value = 1, frequency = 4)

```


```{r}
#Tjek om rigtige

eq_h_row_rvx = dummy_1*0.06*eq_h_rvx + dummy_2*eq_h_row_rv
eq_h_nf_rvx = dummy_1*0.57*eq_h_rvx + dummy_2*eq_h_nf_rv
eq_h_f_rvx = dummy_1*0.37*eq_h_rvx + dummy_2*eq_h_f_rv
eq_h_rvx1 = eq_h_nf_rvx + eq_h_f_rvx + eq_h_row_rvx

```

We now create stock of equities data based on counter parties.

```{r}
alpha_nf = eq_h_nf[31:60]/eq_h[31:60] #mean of the series 0.275
alpha_f = eq_h_f[31:60]/eq_h[31:60] #mean of the series 0.663
#alpha_row = eq_h_row/eq_h
alpha_row = 1 - alpha_nf - alpha_f
```

```{r}
#eq_h_nf = dummy_1*0.275*eq_h + dummy_2*eq_h_nf
#eq_h_f = dummy_1*0.663*eq_h + dummy_2*eq_h_f
#eq_h_row = dummy_1*0.062*eq_h  + dummy_2*eq_h_row 
```

```{r}
gamma_1 = eq_h_nf / eq_h
gamma_2 = eq_h_f / eq_h
```

```{r}
#series  iba_h_tr = fn
```

```{r}
library(stats)

div_nf2_adj = (div_r_nf  - div_p_nf) - ((stats::lag(eq_nf_a_nf,1) + stats::lag(eq_nf_a_f,1) - stats::lag(eq_nf_l_nf,1) + stats::lag(eq_h_nf,1)+ stats::lag(eq_row_a_nf,1) + stats::lag(eq_f_a_nf,1) + stats::lag(eq_g_nf,1)))* stats::lag(divd,1) + stats::lag(eq_nf_a_row,1)*stats::lag(diva,1)
```

```{r}
div_nf1_adj =  (div_r_nf  - div_p_nf) - (stats::lag(Neq_nf,1)*stats::lag(divd,1))
```

```{r}
div_nf_adj = d_20124*(div_nf2_adj) + (1-d_20124)*(div_nf1_adj)
```
```{r}
div_nf =d_20124*(((stats::lag(eq_nf_a_nf,1) + stats::lag(eq_nf_a_f,1) - stats::lag(eq_nf_l_nf,1) + stats::lag(eq_h_nf,1) + stats::lag(eq_row_a_nf,1) + stats::lag(eq_f_a_nf,1) + stats::lag(eq_g_nf,1)))* stats::lag(divd,1) + stats::lag(eq_nf_a_row,1)*stats::lag(diva,1)) + (1-d_20124)*(stats::lag(Neq_nf,1)*stats::lag(divd,1)) + div_nf_adj

div_nf1 =  div_r_nf - div_p_nf
```

```{r}
div_f2_adj = (div_r_f  - div_p_f) - ((stats::lag(eq_f_a_nf,1) + stats::lag(eq_f_a_f,1) - (stats::lag(eq_f_l_f,1) + stats::lag(eq_h_f,1)+ stats::lag(eq_row_a_f,1) + stats::lag(eq_row_a_f,1) + stats::lag(eq_g_f,1)))* stats::lag(divd,1) + stats::lag(eq_f_a_row,1)*stats::lag(diva,1))
```

```{r}
div_f1_adj =  (div_r_f  - div_p_f) - (stats::lag(Neq_f,1)*stats::lag(divd,1))
div_f_adj = d_20124*div_f2_adj + (1-d_20124)*(div_f1_adj)

```

```{r}
div_f = d_20124 *(((stats::lag(eq_f_a_f,1) + stats::lag(eq_nf_a_nf,1)) - (stats::lag(eq_f_l_f,1) + stats::lag(eq_h_f,1)+ stats::lag(eq_row_a_f,1) + stats::lag(eq_nf_a_f,1) + stats::lag(eq_g_f,1)))* stats::lag(divd,1) + stats::lag(eq_f_a_row,1)*stats::lag(diva,1)) + (1-d_20124)*((stats::lag(Neq_f,1)*stats::lag(divd,1))) +  div_f_adj 

div_f1 =  div_r_f - div_p_f
```


```{r}
div_h2_adj = div_r_h - ((stats::lag(eq_h_nf,1) + stats::lag(eq_h_f,1))*stats::lag(divd,1) + stats::lag(eq_h_row,1)*stats::lag(diva,1))

div_h1_adj =  div_r_h - (stats::lag(eq_h,1)*stats::lag(divd,1))

div_h_adj  = d_20124*div_h2_adj + (1-d_20124)*(div_h1_adj)
```

```{r}
div_h = d_20124*((stats::lag(eq_h_nf,1) + stats::lag(eq_h_f,1))*stats::lag(divd,1) + stats::lag(eq_h_row,1)*stats::lag(diva,1)) + (1-d_20124)*(stats::lag(eq_h,1)*stats::lag(divd,1)) +  div_h_adj

div_h1 = div_r_h - div_p_h
```

```{r}
div_g2_adj = div_r_g - ((stats::lag(eq_g_nf,1) + stats::lag(eq_g_f,1))*stats::lag(divd,1) + stats::lag(eq_g_row,1)*stats::lag(diva,1))

div_g1_adj =  div_r_g - (stats::lag(eq_g,1)*stats::lag(divd,1))

div_g_adj = d_20124*div_g2_adj + (1-d_20124)*(div_g1_adj)

div_g = d_20124 * ( (stats::lag(eq_g_nf,1) + stats::lag(eq_g_f,1))*stats::lag(divd,1) + stats::lag(eq_g_row,1)*stats::lag(diva,1) ) + (1-d_20124) * ((stats::lag(eq_g,1)*stats::lag(divd,1))) + div_g_adj

div_g1 =  div_r_g - div_p_g
```

```{r}
div_row2_adj = (div_r_row - div_p_row) - ((stats::lag(eq_row_a_nf,1) + stats::lag(eq_row_a_f,1))*stats::lag(divd,1) - ((stats::lag(eq_nf_a_row,1)+stats::lag(eq_f_a_row,1)+stats::lag(eq_g_row,1)+stats::lag(eq_h_row,1))*stats::lag(diva,1)))

div_row1_adj = (div_r_row - div_p_row) - (stats::lag(Neq_row,1)*stats::lag(divd,1))

div_row_adj = d_20124*div_row2_adj + (1-d_20124)*(div_row1_adj)
```

```{r}
div_row = d_20124 * (  (stats::lag(eq_row_a_nf,1) + stats::lag(eq_row_a_f,1))*stats::lag(divd,1) - ((stats::lag(eq_nf_a_row,1)+stats::lag(eq_f_a_row,1)+stats::lag(eq_g_row,1)+stats::lag(eq_h_row,1))*stats::lag(diva,1))) + (1-d_20124) * ((stats::lag(Neq_row,1)*stats::lag(divd,1))) + div_row_adj
```

```{r}
div_row1 =  div_r_row - div_p_row
```


```{r}
check_div1 =  (div_r_row - div_p_row) +  (div_r_g - div_p_g) +  (div_r_h - div_p_h) +  (div_r_nf - div_p_nf) +  (div_r_f - div_p_f)

check_div = div_h + div_f + div_g + div_nf + div_row

check_div_adj1 = div_h1_adj  + div_f1_adj  +div_nf1_adj  +div_g1_adj  +div_row1_adj   

check_div_adj2 = div_h2_adj  + div_f2_adj  +div_nf2_adj  +div_g2_adj  +div_row2_adj   
```

```{r}
ins_nf_adj = (ins_r_nf - ins_p_nf) - (stats::lag(ins_nf,1)*stats::lag(insu,1))
ins_f_adj = (ins_r_f - ins_p_f) - (stats::lag(ins_f,1)*stats::lag(insu,1))
ins_g_adj = (ins_r_g - ins_p_g) - (stats::lag(ins_g,1)*stats::lag(insu,1))
ins_h_adj = (ins_r_h - ins_p_h) - (stats::lag(ins_h,1)*stats::lag(insu,1))
ins_row_adj = (ins_r_row - ins_p_row) - (stats::lag(ins_row,1)*stats::lag(insu,1))
```

```{r}
ins_h_tr_excl_d8 = ins_h_tr - d8_h
```

Below I compute the adjustment variables that correct the discrepancy between net lending and financial net lending


```{r}
nl_h = s_h - i_h - np_h + ctr_h
fnl_h = iba_h_tr + sec_h_tr + l_h_tr + eq_h_tr + ins_h_tr
nl_h_adj = fnl_h -nl_h
```

```{r}
nl_nf = s_nf - i_nf - np_nf + ctr_nf
fnl_nf = iba_nf_tr + sec_nf_tr + l_nf_tr + Neq_nf_tr + ins_nf_tr
nl_nf_adj = fnl_nf - nl_nf
```

```{r}
nl_f = s_f - i_f - np_f + ctr_f
fnl_f = iba_f_tr + sec_f_a_tr + sec_f_d_tr + l_f_tr + eq_f_a_tr - eq_f_l_tr + ins_f_tr
nl_f_adj = fnl_f - nl_f
```


```{r}
nl_g = s_g - i_g - np_g + ctr_g
fnl_g = iba_g_tr + eq_g_tr + sec_g_tr + l_g_tr + ins_g_tr
nl_g_adj = fnl_g - nl_g 
```


```{r}
int_row = (stats::lag(idep,1)*stats::lag(iba_row,1) + stats::lag(iboa,1)*stats::lag(sec_row,1) + stats::lag(iloan,1)*stats::lag(l_row,1))

div_row = d_20124*(  (stats::lag(eq_row_a_nf,1) + stats::lag(eq_row_a_f,1))*stats::lag(divd,1) - ((stats::lag(eq_nf_a_row,1)+stats::lag(eq_f_a_row,1)+stats::lag(eq_g_row,1)+stats::lag(eq_h_row,1))*stats::lag(diva,1))) + (1-d_20124) * ((stats::lag(Neq_row,1)*stats::lag(divd,1))) + div_row_adj

insu_row = stats::lag(ins_row,1)*stats::lag(insu,1) 

npropinc_row = int_row + int_row_adj + div_row + insu_row + ins_row_adj + (res_r_row) - (res_p_row)

nl_row = m - x + p_tax_row - p_sub_row + (w_row_r - w_row_p) +  (npropinc_row) + (tax_row) + scon_row_r - scon_row_p + sben_row_r - sben_row_p + oth_row + ctr_row - np_row 

fnl_row = iba_row_tr + Neq_row_tr  + sec_row_tr + l_row_tr + ins_row_tr

nl_row_adj = fnl_row - nl_row 
```


```{r}
sumfnl = fnl_h + fnl_f + fnl_nf + fnl_g + fnl_row
sumnl = nl_h + nl_f + nl_nf + nl_g + nl_row
sumnladj = nl_h_adj + nl_f_adj + nl_nf_adj + nl_g_adj + nl_row_adj
```

tax rates for wages and property income (the two tax rates are determined throgh an exogenous regression without an intercept

```{r}


tax_rate1 = 0.389369
tax_rate2 = 0.152767
tax_h_hat =  tax_rate1*(w_h_r +nsben_h + oth_h) +  tax_rate2*(propinc_r_h - propinc_p_h + b2_h_r) 
tax_h_adj = (-tax_h -  tax_h_hat)
tax_h =  -(tax_h_hat + tax_h_adj)
yd2a_h =(1 - tax_rate2)*(propinc_r_h + b2_h_r) # property income part of the disposable income (capitalists)
yd2b_h = (1 - tax_rate2)*(-propinc_p_h) 
yd1_h =(1 - tax_rate1)*(w_h_r + nsben_h + oth_h) - tax_h_adj # wage and benefits part of the disposable income (workers)
tax_rate_nf = -tax_nf/y
```

Creating Real variables

```{r}
yd_hk=yd_h/pc # real disposable income
 w_h_rk = w_h_r/pc #real wages recieved by households
 nsben_hk  = nsben_h /pc #real social benefits recieved by the households
 npropinc_hk =  npropinc_h/pc # real property income (net) 
 b2_hk = b2_h_r/pc
 yd1_hk = yd1_h/pc  
 yd2a_hk = yd2a_h/pc
 yd2b_hk = yd2b_h/pc
```

```{r}
fnw_hk = fnw_h/pc #real net wealth of households
```

Variables for the estimation of the investment equation

```{r}
u=yk/(bd_nfc_k+equip_nfc_k) #Rate of capacity utilization
prate=s_nf/(stats::lag(bd_nfc,1)+stats::lag(equip_nfc,1)) # Profit rate
```



Labour market

```{r}
#empl = N/1000
#empl_ds = Nadj/1000
 wage = w_h_r / emp
# wage = w_h_rk_ds /(empl_ds)
 Nu=(w_row_r - w_row_p)/wage
 Nf = Nu + emp
 prod = y/Nf
 LF = unemp + emp
 lfadj = unempadj + empadj
 UR = unemp/LF
 ur_ds = unempadj/lfadj
# yk = y/(py/100)
 prodk = yk/Nf
 yf = w + b2
 ws = w/yf
 ps = 1 - ws
# w = w_h_r + (W_row_r - W_row_p)
 fdis = yf/y
 urs = 0.04
 urterm = UR - urs
 wageindex = wage/wage[22] #element from 2010Q3
 priv = pconk + ik + xk
 part = LF*1000/pop
 old_age_ratio = retired_pop/pop
 zaland_jesper = pop - LF*1000  
 nben_h = nsben_h + d8_h
```


```{r}
nl_check= (nl_h + nl_f + nl_nf + nl_g + nl_row) # needs to be fixed:
 fnl_check= (fnl_h + fnl_f + fnl_nf + fnl_g + fnl_row)  # this one is fine: because there is almost no connection between the real side and financial side at the moment
 check_np = np_row + np_h + np_f + np_nf + np_g # this one is fine:
 check_ctr = ctr_row + ctr_h + ctr_f + ctr_nf + ctr_g # this one is fine:
 check_invest = i - i_f - i_nf - i_g - i_h # this one is fine:
 check_iba = iba_h + iba_f + iba_nf + iba_g + iba_row  #needs to be fixed:
 check_tax = tax_g + tax_nf + tax_f + tax_h + tax_row # this one is fine:
  check_iba_rv = iba_h_rv + iba_f_rv + iba_nf_rv + iba_g_rv + iba_row_rv 
  check_iba_tr = iba_h_tr + iba_f_tr + iba_nf_tr + iba_g_tr + iba_row_tr
 check_eq = eq_h + (eq_f_a - eq_f_l) + (eq_nf_a - eq_nf_l) + eq_g + (eq_row_a - eq_row_l) # This one is now fixed
 check_eq_tr = eq_h_tr + Neq_nf_tr  + Neq_f_tr + eq_g_tr + Neq_row_tr + eq_g_tr
  check_l = l_h + l_f + l_nf + l_g + l_row # problematic after scenario 2
 check_l_tr = l_f_tr + l_h_tr + l_nf_tr + l_g_tr + l_row_tr
  check_ins = ins_h + ins_f + ins_nf + ins_g + ins_row # problematic after scenario 2
 check_ins_tr =  ins_f_tr  + ins_h_tr + ins_nf_tr + ins_g_tr + ins_row_tr
check_sec = sec_h + sec_f_a + sec_f_d + sec_nf + sec_g + sec_row ## needs to be fixed
```


Ved ik helt om nedenstående skal med 
```{r}
#smpl 2005q2 2019q1

#equation eq41.ls emp = P(251) + P(252)*SD1 + P(253)*SD2 + P(254)*SD3
#series  emp_ds = emp - (P(251) + P(252)*SD1 + P(253)*SD2 + P(254)*SD3) + @mean(emp)
```


# Estimation


## DEASONALISING THE VARRIABLES


```{r}
pcon_reg = lm(pcon~ sd1+ sd2 + sd3)
pcon_ds= pcon_reg$residuals + mean(pcon)
pcon_ds=ts(pcon_ds,start = c(2005,2), end = c(2020,1), frequency = 4 )

alpha_1=pcon_reg$coefficients[2]
alpha_1=ts(alpha_1,start = c(2005,2), end = c(2020,1), frequency = 4 )

alpha_2=pcon_reg$coefficients[3]
alpha_2=ts(alpha_2,start = c(2005,2), end = c(2020,1), frequency = 4 )

alpha_3=pcon_reg$coefficients[4]
alpha_3=ts(alpha_3,start = c(2005,2), end = c(2020,1), frequency = 4 )

mean_pcon= mean(pcon)
mean_pcon=ts(mean_pcon,start = c(2005,2), end = c(2020,1), frequency = 4 )

```


# The model 

```{r}
library(mFilter)
library(bimets)
library(knitr)
```


Trying first to add all the identity equations 

```{r}

S_model.txt="MODEL

COMMENT> Households 

COMMENT> 
IDENTITY> int_r_h
EQ> int_r_h = TSLAG(idep,1)*TSLAG(iba_h,1)  + TSLAG(ibd,1)*TSLAG(sec_h,1)  + int_r_h_adj   

COMMENT> 
IDENTITY> int_p_h
EQ> int_p_h =  - TSLAG(iloan,1)*TSLAG(l_h,1)  + int_p_h_adj

COMMENT> 
IDENTITY> div_h
EQ> div_h = d_20124*((TSLAG(Eq_h_nf,1) + TSLAG(Eq_h_f,1))*TSLAG(divd,1) + TSLAG(Eq_h_row,1)*TSLAG(diva,1)) + (1-d_20124)*(TSLAG(Eq_h,1)*TSLAG(divd,1)) +  div_h_adj

COMMENT> 
IDENTITY> int_r_h
EQ> int_r_h = TSLAG(idep,1)*TSLAG(iba_h,1)  + TSLAG(ibd,1)*TSLAG(sec_h,1)  + int_r_h_adj



COMMENT> 
IDENTITY> aa_check
EQ> aa_check = Eq_h_f(-1)*divd(-1)


COMMENT> 
IDENTITY> insu_h
EQ> insu_h = ins_h(-1)*insu(-1) + ins_h_adj

COMMENT> 
IDENTITY> propinc_r_h
EQ> propinc_r_h = int_r_h + div_h + insu_h + res_r_h ' property income H

COMMENT> ' property expenditure H
IDENTITY> propinc_p_h
EQ> propinc_p_h = int_p_h + res_p_h 

COMMENT> 
IDENTITY> npropinc_h
EQ> npropinc_h = propinc_r_h - propinc_p_h

COMMENT> Gross income H
IDENTITY> yh_h
EQ> yh_h = w_h_r + b2_h_r + (npropinc_h ) 

COMMENT> 
IDENTITY> yh2a
EQ> yh2a = propinc_r_h + b2_h_r

COMMENT> 
IDENTITY> yh2b
EQ> yh2b = - propinc_p_h

COMMENT> 
IDENTITY> yh1
EQ> yh1 = w_h_r +  nsben_h + oth_h

COMMENT> 
IDENTITY> w_h_r
EQ> w_h_r = wage * emp

COMMENT> ' property income part of the disposable income (capitalists)
IDENTITY> yd2a_h
EQ> yd2a_h =(1 - tax_rate2)*(yh2a) 

COMMENT> 
IDENTITY> yd2b_h
EQ> yd2b_h = (1 - tax_rate2)*(yh2b)

COMMENT> age and benefits part of the disposable income (workers) / tax_h_adj is added here because of the relative size versus yh2
IDENTITY> yd1_h
EQ> yd1_h =(1 - tax_rate1)*(yh1) - tax_h_adj

COMMENT> 
IDENTITY> tax_h
EQ> tax_h = -(tax_rate2*(yh2a+yh2b) +  tax_rate1*yh1 +  tax_h_adj)

COMMENT> 
IDENTITY> insu_h
EQ> insu_h = ins_h(-1)*insu(-1) + ins_h_adj


COMMENT> 
IDENTITY> yd1_hk
EQ> yd1_hk = yd1_h/pc

COMMENT> 
IDENTITY> yd2a_hk
EQ> yd2a_hk = yd2a_h/pc

COMMENT> 
IDENTITY> yd2b_hk
EQ> yd2b_hk = yd2b_h/pc

COMMENT> Disposable income
IDENTITY> yd_h
EQ> yd_h = yd1_h + yd2a_h + yd2b_h

COMMENT> 
IDENTITY> nsben_h
EQ> nsben_h = nben_h - d8_h

COMMENT> Disposable income (redundant for now)
IDENTITY> yd_h1
EQ> yd_h1 = yh_h + Tax_h + nben_h

COMMENT> 
IDENTITY> yd_hk
EQ> yd_hk = yd1_hk + yd2a_hk + yd2b_hk

COMMENT> 
IDENTITY> yd_hk_ds
EQ> yd_hk_ds = yd1_hk_ds + yd2a_hk_ds + yd2b_hk


COMMENT> Savings H
IDENTITY> s_h
EQ> s_h = yd_h - pcon + D8_h

COMMENT> Sectoral balance
IDENTITY> nl_h
EQ> nl_h = s_h - i_h - np_h + ctr_h 



COMMENT> Equation so i can shock to G_bar
BEHAVIORAL> pcon_ds
EQ> TSDELTALOG(PCONK_DS) = C_1 + C_2*TSLAG(LOG(PCONK_DS),1) + C_3*TSLAG(LOG(yd1_hk_ds),1) + C_4*TSLAG(LOG(yd2a_hk_ds),1) + C_5*TSLAG(LOG(fnw_hk),2) + C_6*TSDELTALOG(yd1_hk_ds) + C_7*TSDELTALOG(yd1_hk_ds,2) + C_8*TSDELTALOG(yd2a_hk_ds) + C_9*TSDELTALOG(-yd2b_hk) + C_10*D_2008Q4 + C_11*D_2018Q2 + C_12*D_2020Q1
COEFF> C_1 C_2 C_3 C_4 C_5 C_6 C_7 C_8 C_9 C_10 C_11 
STORE> coe(1)


COMMENT> 
IDENTITY> pconk
EQ> pconk = pconk_ds + P_1 + P_2*SD1 + P_3*SD2 + P_4*SD3 - mean_pconk

COMMENT> nominal private consumption
IDENTITY> pcon
EQ> pcon = pconk*pc

COMMENT> T
BEHAVIORAL> ?????
EQ> TSDELTALOG(I_BD_H_K_DS/BD_H_K,1) = P_620 + P_621*TSDELTALOG(TSLAG(I_BD_H_K_DS,1)/TSLAG(BD_H_K,2))+ P_622*TSDELTALOG(TSLAG(I_BD_H_K_DS,3)/TSLAG(BD_H_K,4))+ P_623*TSDELTALOG(TSLAG(p_bd,1)/TSLAG(pi,1)) + P_624*TSDELTALOG(TSLAG(p_bd,2)/TSLAG(pi,2)) + P_625*TSDELTALOG(TSLAG(yd_hk_ds,2)/TSLAG(bd_h_k,3))+ P_626*TSDELTALOG(TSLAG(-l_h,1)/TSLAG(bd_h,2)) + P_627*LOG(TSLAG(I_BD_H_K_DS,1)/TSLAG(BD_H_K,2)) + P_628*LOG(TSLAG(YD_HK_DS,1)/TSLAG(BD_H_K,2)) + P_629*LOG(TSLAG(P_BD,1)/TSLAG(PI,1)) + P_630*LOG(TSLAG(-L_H,1)/TSLAG(bd_h),2)) + P_631*D_2006Q4 + P_632*D_2014Q4 
COEFF> P_20 P_21 P_22 P_23 P_24 P_25 P_26 P_27 P_28 P_29 P_30 P_31 P_32 STORE> coe(2)

COMMENT> 
IDENTITY> i_bd_h_k
EQ> i_bd_h_k = i_bd_h_k_ds + (P_144 + P_145*SD1 + P_146*SD2 + P_147*SD3) - mean_i_bd_h_k

COMMENT> Skriv om!!!!
BEHAVIORAL> ?????
EQ> DLOG(I_EQUIP_H_K_DS/EQUIP_H_K(-1)) = P(636) + P(637) * DLOG(I_EQUIP_H_K_DS(-1)/EQUIP_H_K(-2)) + P(638) * DLOG(I_EQUIP_H_K_DS(-2)/EQUIP_H_K(-3)) + P(639)*DLOG(YD_HK_DS/EQUIP_H_K(-1)) + P(640)*DUMMY4 
COEFF> P_20 P_21 P_22 P_23 P_24 P_25 P_26 P_27 P_28 P_29 P_30 P_31 P_32 STORE> coe(2)

COMMENT> 
IDENTITY> i_equip_h_k
EQ>  i_equip_h_k = i_equip_h_k_ds + P_168 + P_169*SD1 + P_170*SD2 + P_171*SD3 - mean-i_equip_h_k

COMMENT>
BEHAVIORAL> NBEN_H1
EQ> TSDELTALOG(NBEN_H1) = P_671 + P_672*TSDELTALOG(ZALAND_JESPER) + P_673*TSDELTA(UNEMP) + P_674*TSDELTA(TSLAG(unemp,1)) +   P_675*LOG(TSLAG(NBEN_H,1)) + P_676*TSLAG(UNEMP,1) + P_677*LOG(TSLAG(ZALAND_JESPER,1))
COEFF> P_671 P_672 P_673 P_674 P_675 P_676 P_677
STORE> coe(1)



COMMENT> Financial side


COMMENT> Skriv om!!!!
BEHAVIORAL> pconk
EQ> D(-L_H_TR/(YD_HK_DS*PC)) = P(641)*D(-L_H_TR(-2)/(YD_HK_DS(-2)*PC(-2))) + P(642)*D(ILOAN) + P(643)*DLOG(I_BD_H_K_DS(-3)/(YD_HK_DS(-3))) + P(644)*-L_H_TR(-1)/(YD_HK_DS(-1)*PC(-1)) + P(645)*LOG(-L_H(-2)/(YD_HK_DS(-2)*PC(-2))) + P(646) + P(647)*D_2007Q34 + P(648)*@TREND




COMMENT> 
IDENTITY> IBA_h
EQ> IBA_h= IBA_h(-1) + IBA_h_tr + IBA_h_rvx

COMMENT> For the time being we take sec_h_tr as exogenous. It is assumed that households' holdings of securities are entirely issued by the government.
IDENTITY> Sec_h
EQ> Sec_h= Sec_h(-1) + Sec_h_tr + Sec_h_rvx

COMMENT> 
IDENTITY> sec_h_tr_g
EQ> sec_h_tr_g=sec_h_tr

COMMENT> 
IDENTITY> L_h
EQ> L_h= L_h(-1) + L_h_tr + L_h_rvx

COMMENT> 
IDENTITY> Sec_h
EQ> Sec_h= Sec_h(-1) + Sec_h_tr + Sec_h_rvx

COMMENT> 
IDENTITY> Sec_h
EQ> Sec_h= Sec_h(-1) + Sec_h_tr + Sec_h_rvx

COMMENT> 
IDENTITY> Sec_h
EQ> Sec_h= Sec_h(-1) + Sec_h_tr + Sec_h_rvx

COMMENT> 
IDENTITY> Sec_h
EQ> Sec_h= Sec_h(-1) + Sec_h_tr + Sec_h_rvx

COMMENT> 
IDENTITY> Sec_h
EQ> Sec_h= Sec_h(-1) + Sec_h_tr + Sec_h_rvx


END"
```


# Noter til model

Jeg forsøger at estimere seasonality i modellen? Eller skal jeg forsøge uden for modellen først

- Ved ik om jeg kan få den til at tage mean oppe i modellen, hvis ikke skal mean laves som en exogen variable nede ved tidsserierne. 




```{r}
options(scipen = 999)


S_model=LOAD_MODEL(modelText = S_model.txt)
```



```{r}

# I think I should create the timeseries for the coeff. 

S_modelData=list(  
  y  = TIMESERIES(c(y),   
                  START=c(2005,2),FREQ=4),
  pcon  = TIMESERIES(c(pcon),   
                     START=c(2005,2),FREQ=4),
  g = TIMESERIES(c(g),   
                  START=c(2005,2),FREQ=4),
  yh_h = TIMESERIES(c(yh_h),   
                  START=c(2005,2),FREQ=4),
  b2_h_r = TIMESERIES(c(b2_h_r),   
                  START=c(2005,2),FREQ=4),
  pcon_ds = TIMESERIES(c(pcon_ds),   
                  START=c(2005,2),FREQ=4),
  sd1 = TIMESERIES(c(sd1),   
                  START=c(2005,2),FREQ=4),
  sd2 = TIMESERIES(c(sd2),   
                  START=c(2005,2),FREQ=4),
  sd3 = TIMESERIES(c(sd3),   
                  START=c(2005,2),FREQ=4),
  D_2008Q4 = TIMESERIES(c(d_2008q4),   
                  START=c(2005,2),FREQ=4),
  PCON_ds = TIMESERIES(c(pcon_ds),   
                  START=c(2005,2),FREQ=4),
  alpha_1 = TIMESERIES(c(alpha_1),   
                  START=c(2005,2),FREQ=4),
  alpha_2 = TIMESERIES(c(alpha_2),   
                  START=c(2005,2),FREQ=4),
  alpha_3 = TIMESERIES(c(alpha_3),   
                  START=c(2005,2),FREQ=4),
  mean_pcon = TIMESERIES(c(mean_pcon),   
                  START=c(2005,2),FREQ=4)
)


S_model=LOAD_MODEL_DATA(S_model,S_modelData)
```


```{r}
#Estimate model coefficients
S_model=ESTIMATE(S_model
                 ,TSRANGE=c(2005,4,2020,1)
                 ,forceTSRANGE = TRUE
)
```

```{r}
# In-sample prediction (no add factors)
S_model <- SIMULATE(S_model
                    ,simType='STATIC'
                    ,TSRANGE=c(2005,4,2020,1)
                    ,simConvergence=0.00001
                    ,simIterLimit=100
                   )
```
```{r}
y_00 = S_model$simulation$y
pcon_00 = S_model$simulation$pcon
pcon_ds_00 = S_model$simulation$PCON_ds


```

```{r}
plot(pcon_00)
plot(pcon_ds)
```

# Shocks

## Scenario 1

We create a shock to the deseasonalized consumption of -10000

```{r}

# Define add-factor list (defining shock)
constantAdjList <- list(
  
  pcon_ds = TIMESERIES(-10000,START=c(2010,1), END=c(2010,1),  FREQ='Q')

)

```


```{r}
# Simulate the model (following shock)
S_model <- SIMULATE(S_model
                    ,simType='DYNAMIC'
                    ,TSRANGE=c(2005,4,2020,1)
                    ,simConvergence=0.00001
                    ,simIterLimit=100
                    ,ConstantAdjustment=constantAdjList
                    ,quietly=TRUE)
```


```{r}
pcon_ds_1 = S_model$simulation$pcon_ds
pcon_1 = S_model$simulation$pcon
```

```{r}
plot(pcon_ds_1)
plot(pcon_1)
```
