---
title: "The real model"
author: "Simon"
date: "27/6/2022"
output: html_document
---

# Packages

```{r}
library(tstools)
```


# Import data

```{r}
AAMK <- read_excel("AAMK.xlsx")

names(AAMK) <- tolower(names(AAMK))

AAMK=lapply(AAMK, function(t) ts(t, start=c(2005, 2), end=c(2020, 1),frequency=4))
attach(AAMK)
```



```{r}
eq_nf_l_nf = res_eq_nf_l
eq_f_l_f = res_eq_f_l
```


# PARAMETERS

## Create dummies


```{r}
d_2006q1=create_dummy_ts(start_basic = c(2005, 2), end_basic=c(2020,1),
 dummy_start=c(2006,1), dummy_end = c(2006,1),
 basic_value = 0, dummy_value = 1, frequency = 4)

d_2006q2=create_dummy_ts(start_basic = c(2005, 2), end_basic=c(2020,1),
 dummy_start=c(2006,2), dummy_end = c(2006,2),
 basic_value = 0, dummy_value = 1, frequency = 4)

d_2006q3=create_dummy_ts(start_basic = c(2005, 2), end_basic=c(2020,1),
 dummy_start=c(2006,3), dummy_end = c(2006,3),
 basic_value = 0, dummy_value = 1, frequency = 4)

d_2006q4=create_dummy_ts(start_basic = c(2005, 2), end_basic=c(2020,1),
 dummy_start=c(2006,4), dummy_end = c(2006,4),
 basic_value = 0, dummy_value = 1, frequency = 4)

d_2007q34=create_dummy_ts(start_basic = c(2005, 2), end_basic=c(2020,1),
 dummy_start=c(2007,3), dummy_end = c(2007,4),
 basic_value = 0, dummy_value = 1, frequency = 4)

d_2008q2=create_dummy_ts(start_basic = c(2005, 2), end_basic=c(2020,1),
 dummy_start=c(2008,2), dummy_end = c(2008,2),
 basic_value = 0, dummy_value = 1, frequency = 4)

d_2008q3=create_dummy_ts(start_basic = c(2005, 2), end_basic=c(2020,1),
 dummy_start=c(2008,3), dummy_end = c(2008,3),
 basic_value = 0, dummy_value = 1, frequency = 4)

d_2008q4=create_dummy_ts(start_basic = c(2005, 2), end_basic=c(2020,1),
 dummy_start=c(2008,4), dummy_end = c(2008,4),
 basic_value = 0, dummy_value = 1, frequency = 4)

d_2009q4=create_dummy_ts(start_basic = c(2005, 2), end_basic=c(2020,1),
 dummy_start=c(2009,4), dummy_end = c(2009,4),
 basic_value = 0, dummy_value = 1, frequency = 4)

d_2018q2=create_dummy_ts(start_basic = c(2005, 2), end_basic=c(2020,1),
 dummy_start=c(2018,2), dummy_end = c(2018,2),
 basic_value = 0, dummy_value = 1, frequency = 4)

##### Er der noget specielt med dem her?????

d_20123=create_dummy_ts(start_basic = c(2005, 2), end_basic=c(2020,1),
 dummy_start=c(2012,3), dummy_end = c(2012,3),
 basic_value = 0, dummy_value = 1, frequency = 4)

d_20124=create_dummy_ts(start_basic = c(2005, 2), end_basic=c(2020,1),
 dummy_start=c(2012,4), dummy_end = c(2012,4),
 basic_value = 0, dummy_value = 1, frequency = 4)

#### Videre igen 

d_2009q1=create_dummy_ts(start_basic = c(2005, 2), end_basic=c(2020,1),
 dummy_start=c(2009,1), dummy_end = c(2009,1),
 basic_value = 0, dummy_value = 1, frequency = 4)

d_2011q1=create_dummy_ts(start_basic = c(2005, 2), end_basic=c(2020,1),
 dummy_start=c(2011,1), dummy_end = c(2011,1),
 basic_value = 0, dummy_value = 1, frequency = 4)

d_2014q3=create_dummy_ts(start_basic = c(2005, 2), end_basic=c(2020,1),
 dummy_start=c(2014,3), dummy_end = c(2014,3),
 basic_value = 0, dummy_value = 1, frequency = 4)

d_2014q4=create_dummy_ts(start_basic = c(2005, 2), end_basic=c(2020,1),
 dummy_start=c(2014,4), dummy_end = c(2014,4),
 basic_value = 0, dummy_value = 1, frequency = 4)

d_2013q4=create_dummy_ts(start_basic = c(2005, 2), end_basic=c(2020,1),
 dummy_start=c(2013,4), dummy_end = c(2013,4),
 basic_value = 0, dummy_value = 1, frequency = 4)

d_2018q1=create_dummy_ts(start_basic = c(2005, 2), end_basic=c(2020,1),
 dummy_start=c(2018,1), dummy_end = c(2018,1),
 basic_value = 0, dummy_value = 1, frequency = 4)

d_2016q3=create_dummy_ts(start_basic = c(2005, 2), end_basic=c(2020,1),
 dummy_start=c(2016,3), dummy_end = c(2016,3),
 basic_value = 0, dummy_value = 1, frequency = 4)

d_2019q3=create_dummy_ts(start_basic = c(2005, 2), end_basic=c(2020,1),
 dummy_start=c(2019,3), dummy_end = c(2019,3),
 basic_value = 0, dummy_value = 1, frequency = 4)

d_2019q4=create_dummy_ts(start_basic = c(2005, 2), end_basic=c(2020,1),
 dummy_start=c(2019,4), dummy_end = c(2019,4),
 basic_value = 0, dummy_value = 1, frequency = 4)

d_2020q1=create_dummy_ts(start_basic = c(2005, 2), end_basic=c(2020,1),
 dummy_start=c(2020,1), dummy_end = c(2020,1),
 basic_value = 0, dummy_value = 1, frequency = 4)

DUMMY_4= ts(c(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0), start = c(2005, 2), end =  c(2020,1), frequency = 4)

```


# Variables 

## Real Variables 

```{r}
pc = pc/100
px = px/100
pi = pi/100
pg= pg/100
pm = pm/100
py = py/100
pf = pc*xr/rer
rer = pc*xr/pf
pconk = pcon/pc
gk = g/pg
xk = x/px
mk = m/pm
```



```{r}

i_adj_h = i_h -  (i_equip_h + i_bd_h)
i_adj_nfc = i_nf - (i_equip_nfc + i_bd_nfc)
i_adj_fc = i_f - (i_equip_fc + i_bd_fc)
i_adj_g = i_g - (i_equip_g +i_bd_g)
```

```{r}
i_equip_h_k = i_equip_h/p_equip
i_equip_nfc_k =  i_equip_nfc/p_equip
i_equip_g_k = i_equip_g/p_equip
i_equip_fc_k =  i_equip_fc/p_equip
```


```{r}
i_bd_h_k =  i_bd_h/p_bd
i_bd_nfc_k =  i_bd_nfc/p_bd
i_bd_g_k =  i_bd_g/p_bd
i_bd_fc_k =  i_bd_fc/p_bd
```


I just deflate the adjustment terms using p_equip as well (assuming most of it is changes in inventories)

```{r}
i_adj_h_k = i_adj_h /p_equip
i_adj_nfc_k = i_adj_nfc /p_equip
i_adj_fc_k = i_adj_fc /p_equip
i_adj_g_k = i_adj_g /p_equip
```

we can compare ik with ikk. just to make sure we have all components of investment.

-- Ved ik om "ik" og "ikk" skal give det samme men gør de ik --

```{r}
ik =  i_equip_h_k + i_equip_nfc_k  +  i_equip_g_k + i_equip_fc_k +  i_bd_h_k + i_bd_nfc_k  +  i_bd_g_k  + i_bd_fc_k + i_adj_h_k + i_adj_nfc_k + i_adj_fc_k + i_adj_g_k

ikk = i/pi


cbind(ik, ikk) # spg Mikael
```



```{r}
yk = ik + pconk + gk + xk - mk
```

```{r}

npropinc_h = propinc_r_h - propinc_p_h
nsben_h = sben_h_r - scon_h_p
```

```{r}
iba_f = - (iba_h + iba_nf + iba_g + iba_row) # The data from the database is not consistent (the sum of the stocks of IBA does not add up to zero). I fix it by assuming that iba_f is entirely demand-led.

iba_f_tr = - (iba_h_tr + iba_nf_tr + iba_g_tr + iba_row_tr) #The data from the database is not consistent (the sum of IBA transactions does not add up to zero). I fix it by assuming that iba_f_tr is entirely demand-led.
```


```{r}
### Jeg tager bare og fjerner første observation fra dem der er minuse så den først starer i 2005q3

iba_h_rvx=diff(iba_h)-iba_h_tr[-1]
iba_f_rvx=diff(iba_f)-iba_f_tr[-1]
iba_nf_rvx=diff(iba_nf)-iba_nf_tr[-1]
iba_g_rvx=diff(iba_g)-iba_g_tr[-1]
iba_row_rvx=diff(iba_row)-iba_row_tr[-1]
```


```{r}
eq_h = - ((eq_f_a - eq_f_l) + (eq_nf_a - eq_nf_l) + eq_g + (eq_row_a - eq_row_l)) #The data from the database is not consistent (the sum of the stocks of equities does not add up to zero). I fix it by assuming that eq_h absorbbs the small discrepancies that come from the database.
```


```{r}
### Der ages diff så de sarer alle i 2005Q3

eq_h_rvx=diff(eq_h)-eq_h_tr[-1]
eq_f_a_rvx=diff(eq_f_a)-eq_f_a_tr[-1]
eq_f_l_rvx=diff(eq_f_l)-eq_f_l_tr[-1]
eq_nf_a_rvx=diff(eq_nf_a)-eq_nf_a_tr[-1]
eq_nf_l_rvx=diff(eq_nf_l)-eq_nf_l_tr[-1]
eq_g_rvx=diff(eq_g)-eq_g_tr[-1]
eq_row_a_rvx=diff(eq_row_a)-eq_row_a_tr[-1]
eq_row_l_rvx=diff(eq_row_l)-eq_row_l_tr[-1]
```


```{r}

### Tror også alle disse starer i 2005Q3

Neq_row = eq_row_a - eq_row_l 
Neq_nf = eq_nf_a - eq_nf_l 
Neq_f = eq_f_a - eq_f_l 
Neq_nf_rvx = eq_nf_a_rvx-eq_nf_l_rvx
Neq_f_rvx = eq_f_a_rvx-eq_f_l_rvx
Neq_row_rvx = eq_row_a_rvx-eq_row_l_rvx
Neq_nf_tr = diff(Neq_nf)-(Neq_nf_rvx)
Neq_f_tr = diff(Neq_f)-(Neq_f_rvx)
alpha_neq_nf = -Neq_nf/i_nf
Neq_row_tr = diff(Neq_row) - Neq_row_rvx
```

```{r}
# Igen starter førsst i 2005Q3

eq_h_tr = - (Neq_nf_tr  + Neq_f_tr + eq_g_tr[-1] + Neq_row_tr) # The data from the database is not consistent (the sum of the stocks of equities does not add up to zero). I fix it by assuming that eq_h_tr absorbbs the small discrepancies that come from the database.
```

```{r}
eq_f_l_rvx = diff(eq_f_l)-eq_f_l_tr[-1]
eq_nf_l_rvx = diff(eq_nf_l)-eq_nf_l_tr[-1]
eq_row_l_rvx = diff(eq_row_l)-eq_row_l_tr[-1]

```

```{r}
ins_f = - (ins_row + ins_h + ins_nf + ins_g) # The database is almost consistent, but I redifine ins_f to make it fully consistent and avoid carrying discrepancies along when running the simulations.
ins_f_tr = - (ins_row_tr + ins_h_tr + ins_nf_tr + ins_g_tr) # The database is almost consistent, but I redifine ins_f_tr to make it fully consistent and avoid carrying discrepancies along when running the simulations.
```


```{r}

## Samme som før 2005Q3
ins_h_rvx=diff(ins_h)-ins_h_tr[-1]
ins_f_rvx=diff(ins_f)-ins_f_tr[-1]
ins_nf_rvx=diff(ins_nf)-ins_nf_tr[-1]
ins_g_rvx=diff(ins_g)-ins_g_tr[-1]
ins_row_rvx=diff(ins_row)-ins_row_tr[-1]
```

```{r}
sec_g = - (sec_row + sec_h + sec_f_a + sec_f_d + sec_nf) # The database is almost consistent, but I redifine sec_g to make it fully consistent and avoid carrying discrepancies along when running the simulations.
sec_g_tr = - (sec_row_tr + sec_h_tr + sec_f_a_tr + sec_f_d_tr + sec_nf_tr) # The database is almost consistent, but I redifine sec_g to make it fully consistent and avoid carrying discrepancies along when running the simulations.
```

```{r}
sec_h_rvx=diff(sec_h)-sec_h_tr[-1]
sec_f_a_rvx=diff(sec_f_a)-sec_f_a_tr[-1]
sec_f_d_rvx=diff(sec_f_d)-sec_f_d_tr[-1]
sec_nf_rvx=diff(sec_nf)-sec_nf_tr[-1]
sec_g_rvx=diff(sec_g)-sec_g_tr[-1]
sec_row_rvx=diff(sec_row)-sec_row_tr[-1]
```

```{r}
l_f = - (l_h + l_nf + l_g + l_row) # The database is almost consistent, but I redifine l_f to make it fully consistent and avoid carrying discrepancies along when running the simulations.
l_f_tr = - (l_h_tr + l_nf_tr + l_g_tr + l_row_tr) # The database is almost consistent, but I redifine l_f to make it fully consistent and avoid carrying discrepancies along when running the simulations.
```

```{r}
l_h_rvx=diff(l_h)-l_h_tr[-1]
l_f_rvx=diff(l_f)-l_f_tr[-1]
l_nf_rvx=diff(l_nf)-l_nf_tr[-1]
l_g_rvx=diff(l_g)-l_g_tr[-1]
l_row_rvx=diff(l_row)-l_row_tr[-1]
```

```{r}
int_nf_adj = (int_r_nf - int_p_nf) - (stats::lag(idep,n=1)*stats::lag(iba_nf,1) + stats::lag(ibd,1)*stats::lag(sec_nf,1) + stats::lag(iloan,1)*stats::lag(l_nf,1))

int_h_adj = (int_r_h - int_p_h) - (stats::lag(idep,n=1)*stats::lag(iba_h,1) + stats::lag(ibd,1)*stats::lag(sec_h,1) + stats::lag(iloan,1)*stats::lag(l_h,1)) # this calculation calculates the discrepancy for interest payments as net flow.
```

```{r}
#Below I (hamid) compute discrepancy between interest payments and reciepts separately to create a measure of propert income (paid and recieved) instead of just using net property income (npropinc) in the model

int_r_h_adj = int_r_h  - (stats::lag(idep,1)*stats::lag(iba_h,1)  + stats::lag(ibd,1)*stats::lag(sec_h,1))

int_p_h_adj = int_p_h  + stats::lag(iloan,1)*stats::lag(l_h,1)
```


```{r}
#For the rest of the sectors, we just calculate the discrepancies based on net asset holding
int_g_adj = (int_r_g - int_p_g) - (stats::lag(idep,1)*stats::lag(iba_g,1) + stats::lag(iloan,1)*stats::lag(l_g,1) + stats::lag(ibd,1)*stats::lag(sec_g,1))

int_row_adj = (int_r_row - int_p_row) - (stats::lag(idep,1)*stats::lag(iba_row,1) + stats::lag(iboa,1)*stats::lag(sec_row,1) + stats::lag(iloan,1)*stats::lag(l_row,1))


int_f_adj = (int_r_f - int_p_f) - (stats::lag(idep,1)*stats::lag(iba_f,1) + stats::lag(iloan,1)*stats::lag(l_f,1) + stats::lag(ibd,1)*stats::lag(sec_f_d,1) + stats::lag(iboa,1)*stats::lag(sec_f_a,1))
```

```{r}
test = int_nf_adj  + int_h_adj  + int_g_adj  + int_f_adj  + int_row_adj
```


Below we create series for equities viz-a-viz counterparties. The data is only available from 2012 onwards so we use the porportion w.r.t to the aggregate payments to create data back in time (because we have aggregate data)


```{r}


alpha_nf_rv = eq_h_nf_rv[31:60]/(eq_h_nf_rv[31:60] + eq_h_f_rv[31:60] + eq_h_row_rv[31:60]) ## mean of alpha is 0.57 (excluding the spike in the start of the sample somwhere 2013q3 (not sure about the exact point))
alpha_f_rv = eq_h_f_rv[31:60]/(eq_h_nf_rv[31:60] + eq_h_f_rv[31:60] + eq_h_row_rv[31:60]) #  mean of alpha is 0.37 (excluding the spike in the start of the sample somwhere 2013q3 (not sure about the exact point))
alpha_row_rv = eq_h_row_rv[31:60]/(eq_h_nf_rv[31:60] + eq_h_f_rv[31:60] + eq_h_row_rv[31:60]) # mean of alpha is 0.06 (excluding the spike in the start of the sample somwhere 2013q3 (not sure about the exact point))
```


dummies for equity revaluation equations

```{r}
#dummy_1=create_dummy_ts(start_basic = c(2005, 1), end_basic=c(2020,1),
 #dummy_start=c(2005,2), dummy_end = c(2012,4),
 ##basic_value = 0, dummy_value = 1, frequency = 4)

dummy_1=ts(c(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0), start = c(2005, 2), end = c(2020,1), frequency = 4)

dummy_2=create_dummy_ts(start_basic = c(2005, 2), end_basic=c(2020,1),
 dummy_start=c(2013,1), dummy_end = c(2020,1),
 basic_value = 0, dummy_value = 1, frequency = 4)

```


```{r}
#Tjek om rigtige

eq_h_row_rvx = dummy_1*0.06*eq_h_rvx + dummy_2*eq_h_row_rv
eq_h_nf_rvx = dummy_1*0.57*eq_h_rvx + dummy_2*eq_h_nf_rv
eq_h_f_rvx = dummy_1*0.37*eq_h_rvx + dummy_2*eq_h_f_rv
eq_h_rvx1 = eq_h_nf_rvx + eq_h_f_rvx + eq_h_row_rvx

```

We now create stock of equities data based on counter parties.

```{r}
alpha_nf = eq_h_nf[31:60]/eq_h[31:60] #mean of the series 0.275
alpha_f = eq_h_f[31:60]/eq_h[31:60] #mean of the series 0.663
#alpha_row = eq_h_row/eq_h
alpha_row = 1 - alpha_nf - alpha_f
```

```{r}
#eq_h_nf = dummy_1*0.275*eq_h + dummy_2*eq_h_nf
#eq_h_f = dummy_1*0.663*eq_h + dummy_2*eq_h_f
#eq_h_row = dummy_1*0.062*eq_h  + dummy_2*eq_h_row 
```

```{r}
gamma_1 = eq_h_nf / eq_h
gamma_2 = eq_h_f / eq_h
```

```{r}
#series  iba_h_tr = fn
```

```{r}
library(stats)

div_nf2_adj = (div_r_nf  - div_p_nf) - ((stats::lag(eq_nf_a_nf,1) + stats::lag(eq_nf_a_f,1) - stats::lag(eq_nf_l_nf,1) + stats::lag(eq_h_nf,1)+ stats::lag(eq_row_a_nf,1) + stats::lag(eq_f_a_nf,1) + stats::lag(eq_g_nf,1)))* stats::lag(divd,1) + stats::lag(eq_nf_a_row,1)*stats::lag(diva,1)
```

```{r}
div_nf1_adj =  (div_r_nf  - div_p_nf) - (stats::lag(Neq_nf,1)*stats::lag(divd,1))
```

```{r}
div_nf_adj = d_20124*(div_nf2_adj) + (1-d_20124)*(div_nf1_adj)
```
```{r}
div_nf =d_20124*(((stats::lag(eq_nf_a_nf,1) + stats::lag(eq_nf_a_f,1) - stats::lag(eq_nf_l_nf,1) + stats::lag(eq_h_nf,1) + stats::lag(eq_row_a_nf,1) + stats::lag(eq_f_a_nf,1) + stats::lag(eq_g_nf,1)))* stats::lag(divd,1) + stats::lag(eq_nf_a_row,1)*stats::lag(diva,1)) + (1-d_20124)*(stats::lag(Neq_nf,1)*stats::lag(divd,1)) + div_nf_adj

div_nf1 =  div_r_nf - div_p_nf
```

```{r}
div_f2_adj = (div_r_f  - div_p_f) - ((stats::lag(eq_f_a_nf,1) + stats::lag(eq_f_a_f,1) - (stats::lag(eq_f_l_f,1) + stats::lag(eq_h_f,1)+ stats::lag(eq_row_a_f,1) + stats::lag(eq_row_a_f,1) + stats::lag(eq_g_f,1)))* stats::lag(divd,1) + stats::lag(eq_f_a_row,1)*stats::lag(diva,1))
```

```{r}
div_f1_adj =  (div_r_f  - div_p_f) - (stats::lag(Neq_f,1)*stats::lag(divd,1))
div_f_adj = d_20124*div_f2_adj + (1-d_20124)*(div_f1_adj)

```

```{r}
div_f = d_20124 *(((stats::lag(eq_f_a_f,1) + stats::lag(eq_nf_a_nf,1)) - (stats::lag(eq_f_l_f,1) + stats::lag(eq_h_f,1)+ stats::lag(eq_row_a_f,1) + stats::lag(eq_nf_a_f,1) + stats::lag(eq_g_f,1)))* stats::lag(divd,1) + stats::lag(eq_f_a_row,1)*stats::lag(diva,1)) + (1-d_20124)*((stats::lag(Neq_f,1)*stats::lag(divd,1))) +  div_f_adj 

div_f1 =  div_r_f - div_p_f
```


```{r}
div_h2_adj = div_r_h - ((stats::lag(eq_h_nf,1) + stats::lag(eq_h_f,1))*stats::lag(divd,1) + stats::lag(eq_h_row,1)*stats::lag(diva,1))

div_h1_adj =  div_r_h - (stats::lag(eq_h,1)*stats::lag(divd,1))

div_h_adj  = d_20124*div_h2_adj + (1-d_20124)*(div_h1_adj)
```

```{r}
div_h = d_20124*((stats::lag(eq_h_nf,1) + stats::lag(eq_h_f,1))*stats::lag(divd,1) + stats::lag(eq_h_row,1)*stats::lag(diva,1)) + (1-d_20124)*(stats::lag(eq_h,1)*stats::lag(divd,1)) +  div_h_adj

div_h1 = div_r_h - div_p_h
```

```{r}
div_g2_adj = div_r_g - ((stats::lag(eq_g_nf,1) + stats::lag(eq_g_f,1))*stats::lag(divd,1) + stats::lag(eq_g_row,1)*stats::lag(diva,1))

div_g1_adj =  div_r_g - (stats::lag(eq_g,1)*stats::lag(divd,1))

div_g_adj = d_20124*div_g2_adj + (1-d_20124)*(div_g1_adj)

div_g = d_20124 * ( (stats::lag(eq_g_nf,1) + stats::lag(eq_g_f,1))*stats::lag(divd,1) + stats::lag(eq_g_row,1)*stats::lag(diva,1) ) + (1-d_20124) * ((stats::lag(eq_g,1)*stats::lag(divd,1))) + div_g_adj

div_g1 =  div_r_g - div_p_g
```

```{r}
div_row2_adj = (div_r_row - div_p_row) - ((stats::lag(eq_row_a_nf,1) + stats::lag(eq_row_a_f,1))*stats::lag(divd,1) - ((stats::lag(eq_nf_a_row,1)+stats::lag(eq_f_a_row,1)+stats::lag(eq_g_row,1)+stats::lag(eq_h_row,1))*stats::lag(diva,1)))

div_row1_adj = (div_r_row - div_p_row) - (stats::lag(Neq_row,1)*stats::lag(divd,1))

div_row_adj = d_20124*div_row2_adj + (1-d_20124)*(div_row1_adj)
```

```{r}
div_row = d_20124 * (  (stats::lag(eq_row_a_nf,1) + stats::lag(eq_row_a_f,1))*stats::lag(divd,1) - ((stats::lag(eq_nf_a_row,1)+stats::lag(eq_f_a_row,1)+stats::lag(eq_g_row,1)+stats::lag(eq_h_row,1))*stats::lag(diva,1))) + (1-d_20124) * ((stats::lag(Neq_row,1)*stats::lag(divd,1))) + div_row_adj
```

```{r}
div_row1 =  div_r_row - div_p_row
```


```{r}
check_div1 =  (div_r_row - div_p_row) +  (div_r_g - div_p_g) +  (div_r_h - div_p_h) +  (div_r_nf - div_p_nf) +  (div_r_f - div_p_f)

check_div = div_h + div_f + div_g + div_nf + div_row

check_div_adj1 = div_h1_adj  + div_f1_adj  +div_nf1_adj  +div_g1_adj  +div_row1_adj   

check_div_adj2 = div_h2_adj  + div_f2_adj  +div_nf2_adj  +div_g2_adj  +div_row2_adj   
```

```{r}
ins_nf_adj = (ins_r_nf - ins_p_nf) - (stats::lag(ins_nf,1)*stats::lag(insu,1))
ins_f_adj = (ins_r_f - ins_p_f) - (stats::lag(ins_f,1)*stats::lag(insu,1))
ins_g_adj = (ins_r_g - ins_p_g) - (stats::lag(ins_g,1)*stats::lag(insu,1))
ins_h_adj = (ins_r_h - ins_p_h) - (stats::lag(ins_h,1)*stats::lag(insu,1))
ins_row_adj = (ins_r_row - ins_p_row) - (stats::lag(ins_row,1)*stats::lag(insu,1))
```

```{r}
ins_h_tr_excl_d8 = ins_h_tr - d8_h
```

Below I compute the adjustment variables that correct the discrepancy between net lending and financial net lending


```{r}
nl_h = s_h - i_h - np_h + ctr_h
fnl_h = iba_h_tr + sec_h_tr + l_h_tr + eq_h_tr + ins_h_tr
nl_h_adj = fnl_h -nl_h
```

```{r}
nl_nf = s_nf - i_nf - np_nf + ctr_nf
fnl_nf = iba_nf_tr + sec_nf_tr + l_nf_tr + Neq_nf_tr + ins_nf_tr
nl_nf_adj = fnl_nf - nl_nf
```

```{r}
nl_f = s_f - i_f - np_f + ctr_f
fnl_f = iba_f_tr + sec_f_a_tr + sec_f_d_tr + l_f_tr + eq_f_a_tr - eq_f_l_tr + ins_f_tr
nl_f_adj = fnl_f - nl_f
```


```{r}
nl_g = s_g - i_g - np_g + ctr_g
fnl_g = iba_g_tr + eq_g_tr + sec_g_tr + l_g_tr + ins_g_tr
nl_g_adj = fnl_g - nl_g 
```


```{r}
int_row = (stats::lag(idep,1)*stats::lag(iba_row,1) + stats::lag(iboa,1)*stats::lag(sec_row,1) + stats::lag(iloan,1)*stats::lag(l_row,1))

div_row = d_20124*(  (stats::lag(eq_row_a_nf,1) + stats::lag(eq_row_a_f,1))*stats::lag(divd,1) - ((stats::lag(eq_nf_a_row,1)+stats::lag(eq_f_a_row,1)+stats::lag(eq_g_row,1)+stats::lag(eq_h_row,1))*stats::lag(diva,1))) + (1-d_20124) * ((stats::lag(Neq_row,1)*stats::lag(divd,1))) + div_row_adj

insu_row = stats::lag(ins_row,1)*stats::lag(insu,1) 

npropinc_row = int_row + int_row_adj + div_row + insu_row + ins_row_adj + (res_r_row) - (res_p_row)

nl_row = m - x + p_tax_row - p_sub_row + (w_row_r - w_row_p) +  (npropinc_row) + (tax_row) + scon_row_r - scon_row_p + sben_row_r - sben_row_p + oth_row + ctr_row - np_row 

fnl_row = iba_row_tr + Neq_row_tr  + sec_row_tr + l_row_tr + ins_row_tr

nl_row_adj = fnl_row - nl_row 
```


```{r}
sumfnl = fnl_h + fnl_f + fnl_nf + fnl_g + fnl_row
sumnl = nl_h + nl_f + nl_nf + nl_g + nl_row
sumnladj = nl_h_adj + nl_f_adj + nl_nf_adj + nl_g_adj + nl_row_adj
```

tax rates for wages and property income (the two tax rates are determined throgh an exogenous regression without an intercept

```{r}


tax_rate1 = 0.389369
tax_rate2 = 0.152767
tax_h_hat =  tax_rate1*(w_h_r +nsben_h + oth_h) +  tax_rate2*(propinc_r_h - propinc_p_h + b2_h_r) 
tax_h_adj = (-tax_h -  tax_h_hat)
tax_h =  -(tax_h_hat + tax_h_adj)
yd2a_h =(1 - tax_rate2)*(propinc_r_h + b2_h_r) # property income part of the disposable income (capitalists)
yd2b_h = (1 - tax_rate2)*(-propinc_p_h) 
yd1_h =(1 - tax_rate1)*(w_h_r + nsben_h + oth_h) - tax_h_adj # wage and benefits part of the disposable income (workers)
tax_rate_nf = -tax_nf/y
```

Creating Real variables

```{r}
yd_hk=yd_h/pc # real disposable income
 w_h_rk = w_h_r/pc #real wages recieved by households
 nsben_hk  = nsben_h /pc #real social benefits recieved by the households
 npropinc_hk =  npropinc_h/pc # real property income (net) 
 b2_hk = b2_h_r/pc
 yd1_hk = yd1_h/pc  
 yd2a_hk = yd2a_h/pc
 yd2b_hk = yd2b_h/pc
```

```{r}
fnw_hk = fnw_h/pc #real net wealth of households
```

Variables for the estimation of the investment equation

```{r}
u=yk/(bd_nfc_k+equip_nfc_k) #Rate of capacity utilization
prate=s_nf/(stats::lag(bd_nfc,1)+stats::lag(equip_nfc,1)) # Profit rate
```



Labour market

```{r}
#empl = N/1000
#empl_ds = Nadj/1000
 wage = w_h_r / emp
# wage = w_h_rk_ds /(empl_ds)
 Nu=(w_row_r - w_row_p)/wage
 Nf = Nu + emp
 prod = y/Nf
 LF = unemp + emp
 lfadj = unempadj + empadj
 UR = unemp/LF
 ur_ds = unempadj/lfadj
# yk = y/(py/100)
 prodk = yk/Nf
 yf = w + b2
 ws = w/yf
 ps = 1 - ws
# w = w_h_r + (W_row_r - W_row_p)
 fdis = yf/y
 urs = 0.04
 urterm = UR - urs
 wageindex = wage/wage[22] #element from 2010Q3
 priv = pconk + ik + xk
 part = LF*1000/pop
 old_age_ratio = retired_pop/pop
 zaland_jesper = pop - LF*1000  
 nben_h = nsben_h + d8_h
```


```{r}
nl_check= (nl_h + nl_f + nl_nf + nl_g + nl_row) # needs to be fixed:
 fnl_check= (fnl_h + fnl_f + fnl_nf + fnl_g + fnl_row)  # this one is fine: because there is almost no connection between the real side and financial side at the moment
 check_np = np_row + np_h + np_f + np_nf + np_g # this one is fine:
 check_ctr = ctr_row + ctr_h + ctr_f + ctr_nf + ctr_g # this one is fine:
 check_invest = i - i_f - i_nf - i_g - i_h # this one is fine:
 check_iba = iba_h + iba_f + iba_nf + iba_g + iba_row  #needs to be fixed:
 check_tax = tax_g + tax_nf + tax_f + tax_h + tax_row # this one is fine:
  check_iba_rv = iba_h_rv + iba_f_rv + iba_nf_rv + iba_g_rv + iba_row_rv 
  check_iba_tr = iba_h_tr + iba_f_tr + iba_nf_tr + iba_g_tr + iba_row_tr
 check_eq = eq_h + (eq_f_a - eq_f_l) + (eq_nf_a - eq_nf_l) + eq_g + (eq_row_a - eq_row_l) # This one is now fixed
 check_eq_tr = eq_h_tr + Neq_nf_tr  + Neq_f_tr + eq_g_tr + Neq_row_tr + eq_g_tr
  check_l = l_h + l_f + l_nf + l_g + l_row # problematic after scenario 2
 check_l_tr = l_f_tr + l_h_tr + l_nf_tr + l_g_tr + l_row_tr
  check_ins = ins_h + ins_f + ins_nf + ins_g + ins_row # problematic after scenario 2
 check_ins_tr =  ins_f_tr  + ins_h_tr + ins_nf_tr + ins_g_tr + ins_row_tr
check_sec = sec_h + sec_f_a + sec_f_d + sec_nf + sec_g + sec_row ## needs to be fixed
```


Ved ik helt om nedenstående skal med 
```{r}
#smpl 2005q2 2019q1

#equation eq41.ls emp = P(251) + P(252)*SD1 + P(253)*SD2 + P(254)*SD3
#series  emp_ds = emp - (P(251) + P(252)*SD1 + P(253)*SD2 + P(254)*SD3) + @mean(emp)
```


# Estimation


## DEASONALISING THE VARRIABLES


```{r}
pcon_reg = lm(pcon~ sd1+ sd2 + sd3)
pcon_ds= pcon_reg$residuals + mean(pcon)
pcon_ds=ts(pcon_ds,start = c(2005,2), end = c(2020,1), frequency = 4 )

alpha_1=pcon_reg$coefficients[2]
alpha_1=ts(alpha_1,start = c(2005,2), end = c(2020,1), frequency = 4 )

alpha_2=pcon_reg$coefficients[3]
alpha_2=ts(alpha_2,start = c(2005,2), end = c(2020,1), frequency = 4 )

alpha_3=pcon_reg$coefficients[4]
alpha_3=ts(alpha_3,start = c(2005,2), end = c(2020,1), frequency = 4 )

mean_pcon= mean(pcon)
mean_pcon=ts(mean_pcon,start = c(2005,2), end = c(2020,1), frequency = 4 )

```


# The model 

```{r}
library(mFilter)
library(bimets)
library(knitr)
```


Trying first to add all the identity equations 

```{r}

S_model.txt="MODEL

COMMENT> Households 

COMMENT> 
IDENTITY> int_r_h
EQ> int_r_h = TSLAG(idep,1)*TSLAG(iba_h,1)  + TSLAG(ibd,1)*TSLAG(sec_h,1)  + int_r_h_adj   

COMMENT> 
IDENTITY> int_p_h
EQ> int_p_h =  - TSLAG(iloan,1)*TSLAG(l_h,1)  + int_p_h_adj

COMMENT> 
IDENTITY> div_h
EQ> div_h = d_20124*((TSLAG(eq_h_nf,1) + TSLAG(eq_h_f,1))*TSLAG(divd,1) + TSLAG(eq_h_row,1)*TSLAG(diva,1)) + (1-d_20124)*(TSLAG(eq_h,1)*TSLAG(divd,1)) +  div_h_adj


COMMENT> 
IDENTITY> aa_check
EQ> aa_check = TSLAG(eq_h_f,1)*TSLAG(divd,1)


COMMENT> 
IDENTITY> insu_h
EQ> insu_h = TSLAG(ins_h,1)*TSLAG(insu,1) + ins_h_adj

COMMENT>  property income H
IDENTITY> propinc_r_h
EQ> propinc_r_h = int_r_h + div_h + insu_h + res_r_h 

COMMENT> ' property expenditure H
IDENTITY> propinc_p_h
EQ> propinc_p_h = int_p_h + res_p_h 

COMMENT> 
IDENTITY> npropinc_h
EQ> npropinc_h = propinc_r_h - propinc_p_h

COMMENT> Gross income H
IDENTITY> yh_h
EQ> yh_h = w_h_r + b2_h_r + (npropinc_h ) 

COMMENT> 
IDENTITY> yh2a
EQ> yh2a = propinc_r_h + b2_h_r

COMMENT> 
IDENTITY> yh2b
EQ> yh2b = - propinc_p_h

COMMENT> 
IDENTITY> yh1
EQ> yh1 = w_h_r +  nsben_h + oth_h

COMMENT> 
IDENTITY> w_h_r
EQ> w_h_r = wage * emp

COMMENT> ' property income part of the disposable income (capitalists)
IDENTITY> yd2a_h
EQ> yd2a_h =(1 - tax_rate2)*(yh2a) 

COMMENT> 
IDENTITY> yd2b_h
EQ> yd2b_h = (1 - tax_rate2)*(yh2b)

COMMENT> age and benefits part of the disposable income (workers) / tax_h_adj is added here because of the relative size versus yh2
IDENTITY> yd1_h
EQ> yd1_h =(1 - tax_rate1)*(yh1) - tax_h_adj

COMMENT> 
IDENTITY> tax_h
EQ> tax_h = -(tax_rate2*(yh2a+yh2b) +  tax_rate1*yh1 +  tax_h_adj)

COMMENT> 
IDENTITY> yd1_hk
EQ> yd1_hk = yd1_h/pc

COMMENT> 
IDENTITY> yd2a_hk
EQ> yd2a_hk = yd2a_h/pc

COMMENT> 
IDENTITY> yd2b_hk
EQ> yd2b_hk = yd2b_h/pc

COMMENT> Disposable income
IDENTITY> yd_h
EQ> yd_h = yd1_h + yd2a_h + yd2b_h

COMMENT> 
IDENTITY> nsben_h
EQ> nsben_h = nben_h - d8_h

COMMENT> Disposable income (redundant for now)
IDENTITY> yd_h1
EQ> yd_h1 = yh_h + Tax_h + nben_h

COMMENT> 
IDENTITY> yd_hk
EQ> yd_hk = yd1_hk + yd2a_hk + yd2b_hk

COMMENT> 
IDENTITY> yd_hk_ds
EQ> yd_hk_ds = yd1_hk_ds + yd2a_hk_ds + yd2b_hk


COMMENT> Savings H
IDENTITY> s_h
EQ> s_h = yd_h - pcon + D8_h

COMMENT> Sectoral balance
IDENTITY> nl_h
EQ> nl_h = s_h - i_h - np_h + ctr_h 



COMMENT> 
BEHAVIORAL> pcon_ds
EQ> TSDELTALOG(pcon_ds) = C_1 + C_2*TSLAG(LOG(pcon_ds),1) + C_3*TSLAG(LOG(yd1_hk_ds),1) + C_4*TSLAG(LOG(yd2a_hk_ds),1) + C_5*TSLAG(LOG(fnw_hk),2) + C_6*TSDELTALOG(yd1_hk_ds) + C_7*TSDELTALOG(yd1_hk_ds,2) + C_8*TSDELTALOG(yd2a_hk_ds) + C_9*TSDELTALOG(-yd2b_hk) + C_10*D_2008Q4 + C_11*D_2018Q2 + C_12*D_2020Q1
COEFF> C_1 C_2 C_3 C_4 C_5 C_6 C_7 C_8 C_9 C_10 C_11 C_12
STORE> coe(1)


COMMENT> 
IDENTITY> pconk
EQ> pconk = pconk_ds + P_1 + P_2*SD1 + P_3*SD2 + P_4*SD3 - mean_pconk

COMMENT> nominal private consumption
IDENTITY> pcon
EQ> pcon = pconk*pc


COMMENT> Er ikke helt korrekt 
BEHAVIORAL> i_bd_h_k_ds
EQ> LOG(i_bd_h_k_ds) = P_620 + P_621*TSDELTALOG(TSLAG(i_bd_h_k_ds,1)/TSLAG(bd_h_k,2))+ P_622*TSDELTALOG(TSLAG(i_bd_h_k_ds,3)/TSLAG(bd_h_k,4))+ P_623*TSDELTALOG(TSLAG(p_bd,1)/TSLAG(pi,1)) + P_624*TSDELTALOG(TSLAG(p_bd,2)/TSLAG(pi,2)) + P_625*TSDELTALOG(TSLAG(yd_hk_ds,2)/TSLAG(bd_h_k,3))+ P_626*TSDELTALOG(TSLAG(-l_h,1)/TSLAG(bd_h,2)) + P_627*LOG(TSLAG(i_bd_h_k_ds,1)/TSLAG(bd_h_k,2)) + P_628*LOG(TSLAG(yd_hk_ds,1)/TSLAG(bd_h_k,2)) + P_629*LOG(TSLAG(p_bd,1)/TSLAG(pi,1)) + P_630*LOG(TSLAG(-l_h,1)/TSLAG(bd_h,2)) + 
P_631*D_2006Q4 + 
P_632*D_2014Q4 + 
alpha_1*LOG(TSLAG(bd_h_k,1)) + 
alpha_2* TSLAG(LOG(i_bd_h_k_ds),1) + 
alpha_3* TSLAG(-LOG(bd_h_k),2)
COEFF> P_620 P_621 P_622 P_623 P_624 P_625 P_626 P_627 P_628 P_629 P_630 P_631 P_632 alpha_1 alpha_2 alpha_3
RESTRICT> alpha_1 = 1
alpha_2 = 1
alpha_3 = 1
STORE> coe(2)

COMMENT> 
IDENTITY> i_bd_h_k
EQ> i_bd_h_k = i_bd_h_k_ds + (P_144 + P_145*SD1 + P_146*SD2 + P_147*SD3) - mean_i_bd_h_k

COMMENT> 
BEHAVIORAL> i_equip_h_k_ds
EQ> LOG(i_equip_h_k_ds) = p_636 + p_637 * TSDELTALOG(TSLAG(i_equip_h_k_ds,1)/TSLAG(equip_h_k,2)) + p_638 * TSDELTALOG(TSLAG(i_equip_h_k_ds,2)/TSLAG(equip_h_k,3)) + p_639*TSDELTALOG(yd_hk_ds/TSLAG(equip_h_k,1)) + p_640*dummy_4 + alpha_1* TSLAG(LOG(i_equip_h_k_ds),1) + alpha_2* TSLAG(LOG(equip_h_k),1) + alpha_3* TSLAG(-LOG(equip_h_k),2)
COEFF> p_636 p_637 p_638 p_639 p_640 alpha_1 alpha_2 alpha_3
RESTRICT> alpha_1 = 1
alpha_2 = 1
alpha_3 = 1 
STORE> coe(3)

COMMENT> 
IDENTITY> i_equip_h_k
EQ>  i_equip_h_k = i_equip_h_k_ds + P_168 + P_169*SD1 + P_170*SD2 + P_171*SD3 - mean-i_equip_h_k

COMMENT> Har ændret fra NBEN_H1 til nben_h
BEHAVIORAL> nben_h
EQ> TSDELTALOG(nben_h) = P_671 + P_672*TSDELTALOG(ZALAND_JESPER) + P_673*TSDELTA(UNEMP) + P_674*TSDELTA(TSLAG(unemp,1)) +   P_675*LOG(TSLAG(NBEN_H,1)) + P_676*TSLAG(unemp,1) + P_677*LOG(TSLAG(ZALAND_JESPER,1))
COEFF> P_671 P_672 P_673 P_674 P_675 P_676 P_677
STORE> coe(4)



COMMENT> Financial side


COMMENT> Mangler stadig at få tilpasset til ik diff
BEHAVIORAL> l_h_tr
EQ> TSDELTA(l_h_tr) = p_646 *(TSLAG(-yd_hk_ds,1)*TSLAG(pc,1))
+ p_641*((TSDELTA(TSLAG(-l_h_tr,2)/TSLAG(yd_hk_ds,2)*TSLAG(pc,2)))*(TSLAG(-yd_hk_ds,1)*TSLAG(pc,1))) 
+ p_642*TSDELTA(iloan) *(TSLAG(-yd_hk_ds,1)*TSLAG(pc,1))
+ p_643*(TSDELTALOG(TSLAG(i_bd_h_k_ds,3)/TSLAG(yd_hk_ds,3))) *(TSLAG(-yd_hk_ds,1)*TSLAG(pc,1))
+ p_644*((TSLAG(-l_h_tr,1)/TSLAG(yd_hk_ds,1))*TSLAG(pc,1)) *(TSLAG(-yd_hk_ds,1)*TSLAG(pc,1))
+ p_645*(LOG(TSLAG(-l_h,2)/TSLAG(yd_hk_ds,2)*TSLAG(pc,2))) *(TSLAG(-yd_hk_ds,1)*TSLAG(pc,1))
+ p_647*D_2007Q34 *(TSLAG(-yd_hk_ds,1)*TSLAG(pc,1))
+ p_648*time*(TSLAG(-yd_hk_ds,1)*TSLAG(pc,1))
+ alpha_1* ((l_h_tr*(yd_hk_ds*pc - TSLAG(yd_hk_ds,1)*TSLAG(pc,1)))/(yd_hk_ds*pc))
COEFF> p_646 p_641 p_642 p_643 p_644 p_645 p_647 p_648 alpha_1
RESTRICT> alpha_1 = 1
STORE>  coe(1)

COMMENT> 
IDENTITY> iba_h
EQ> iba_h= TSLAG(iba_h,1) + iba_h_tr + iba_h_rvx

COMMENT> For the time being we take sec_h_tr as exogenous. It is assumed that households' holdings of securities are entirely issued by the government.
IDENTITY> sec_h
EQ> sec_h= TSLAG(sec_h,1) + sec_h_tr + sec_h_rvx

COMMENT> 
IDENTITY> sec_h_tr_g
EQ> sec_h_tr_g=sec_h_tr

COMMENT> 
IDENTITY> L_h
EQ> L_h= TSLAG(L_h,1) + L_h_tr + L_h_rvx

COMMENT>  Skkal skrives om!!!
BEHAVIORAL> eq_h
EQ> TSDELTA(eq_h) =  p_770 * (TSLAG(eq_h,1)+TSLAG(sec_h,1)+TSLAG(iba_h,1)) 
+ p_771 * (TSDELTA(TSLAG(ibd,1))* (TSLAG(eq_h,1)+TSLAG(sec_h,1)+TSLAG(iba_h,1)))
+ p_772 * ((TSDELTA(TSLAG(div_r_h,1)+TSLAG(eq_h_rvx,1))/TSLAG(eq_h,2))* (TSLAG(eq_h,1)+TSLAG(sec_h,1)+TSLAG(iba_h,1)))
+ p_773 * ((TSLAG(eq_h,1)- TSLAG(eq_h_rvx,1))/(TSLAG(eq_h,2)+TSLAG(sec_h,2)+TSLAG(iba_h,2))* (TSLAG(eq_h,1)+TSLAG(sec_h,1)+TSLAG(iba_h,1)))
+ p_774 * (TSLAG(ibd,1) * (TSLAG(eq_h,1)+TSLAG(sec_h,1)+TSLAG(iba_h,1)))
+ p_775 * (((TSLAG(div_r_h,2)+TSLAG(eq_h_rvx,2))/TSLAG(eq_h,3)) * (TSLAG(eq_h,1)+TSLAG(sec_h,1)+TSLAG(iba_h,1)))
+ alpha_1* eq_h_rvx
+ alpha_2* ((TSLAG(eq_h,1)*(TSLAG(eq_h,1)+TSLAG(sec_h,1)+TSLAG(iba_h,1))- (TSLAG(eq_h,1)*(TSLAG(eq_h,2)+TSLAG(sec_h,2)+TSLAG(iba_h,2))) - (TSLAG(eq_h_rvx,1)*(TSLAG(eq_h,1)+TSLAG(sec_h,1)+TSLAG(iba_h,1))))/(TSLAG(eq_h,2)+TSLAG(sec_h,2)+TSLAG(iba_h,2)))
COEFF> p_770 p_771 p_772 p_773 p_774 p_775 alpha_1 alpha_2
RESTRICT> alpha_1 = 1
alpha_2 = 1
STORE> coe(1)

COMMENT> 
IDENTITY> eq_h_tr
EQ> eq_h_tr = TSDELTA(eq_h) - eq_h_rvx

COMMENT> 
IDENTITY> iba_h_tr
EQ> iba_h_tr = nl_h - l_h_tr - eq_h_tr  - sec_h_tr - ins_h_tr + nl_h_adj

COMMENT> 
IDENTITY> eq_h_nf
EQ> eq_h_nf = d_20124*alpha_nf *eq_h

COMMENT> 
IDENTITY> eq_h_f
EQ> eq_h_f = d_20124*alpha_f *eq_h


COMMENT> 
IDENTITY> eq_h_row
EQ> eq_h_row = d_20124*alpha_row*eq_h

COMMENT> 
IDENTITY> eq_h_nf_tr
EQ> eq_h_nf_tr = TSDELTA(eq_h_nf) - eq_h_nf_rvx

COMMENT> 
IDENTITY> eq_h_f_tr
EQ> eq_h_f_tr = TSDELTA(eq_h_f) - eq_h_f_rvx

COMMENT> 
IDENTITY> eq_h_row_tr
EQ> eq_h_row_tr = TSDELTA(eq_h_row) - eq_h_row_rvx

COMMENT> 
IDENTITY> eq_h_test
EQ> eq_h_test = eq_h - (eq_h_nf + eq_h_f + eq_h_row)

COMMENT> 
IDENTITY> ins_h
EQ> ins_h= TSLAG(ins_h,1) + ins_h_tr + ins_h_rvx

COMMENT> 
IDENTITY> ins_h_tr
EQ> ins_h_tr = d8_h + ins_h_tr_excl_d8

COMMENT> 
BEHAVIORAL> d8_h
EQ> TSDELTALOG(d8_h) = p_701*TSDELTALOG(TSLAG(d8_h,1)) + p_702*TSDELTALOG(w_h_r) + p_703*TSDELTALOG(TSLAG(old_age_ratio,1)) + p_704*LOG(TSLAG(d8_h,1)) + p_705*LOG(TSLAG(w_h_r,1)) + p_706*LOG(TSLAG(old_age_ratio,1)) + p_707*D_2014Q3
COEFF> p_701 p_702 p_703 p_704 p_705 p_706 p_707
STORE> coe(6)

COMMENT> 
IDENTITY> lev_h
EQ> lev_h = l_h/yd_h

COMMENT> NET WEALTH AND FINANCIAL NET WEALTH

COMMENT> 
IDENTITY> fa_h
EQ> fa_h = iba_h + sec_h + eq_h + ins_h

COMMENT> 
IDENTITY> fnw_h
EQ> fnw_h = fa_h  + l_h

COMMENT> 
IDENTITY> fnw_hk
EQ> fnw_hk = fnw_h/pc

COMMENT> Capital Account

COMMENT>gross fixed capital formation (buildings and dwellings)
IDENTITY> i_bd_h
EQ> i_bd_h = i_bd_h_k * p_bd

COMMENT> gross fixed capital formation (equipment)
IDENTITY> i_equip_h
EQ> i_equip_h = i_equip_h_k * p_equip

COMMENT> Real net stock of buildings and dwellings
IDENTITY> bd_h_k
EQ> TSDELTA(bd_h_k) = i_bd_h_k - TSLAG(bd_h_k,1) * delta_bd_h

COMMENT>  Real net stock of equipment
IDENTITY> equip_h_k
EQ> TSDELTA(equip_h_k) = i_equip_h_k - TSLAG(equip_h_k,1) * delta_equip_h

COMMENT> Nominal net stock of buildings and dwellings
IDENTITY> bd_h
EQ> TSDELTA(bd_h) = i_bd_h + TSLAG(bd_h_k,1) * (1-delta_bd_h)*TSDELTA(p_bd) - TSLAG(bd_h_k,1) * delta_bd_h * p_bd

COMMENT> Nominal net stock of equipment
IDENTITY> equip_h
EQ> TSDELTA(equip_h) = i_equip_h + TSLAG(equip_h_k,1) * (1-delta_equip_h)*TSDELTA(p_equip) - TSLAG(equip_h_k,1) * delta_equip_h * p_equip


COMMENT> NON-FINANCIAL SECTOR

COMMENT> Real side

COMMENT> 
IDENTITY> y
EQ> y = pcon + g + i + x - m

COMMENT> real sales
IDENTITY> yk
EQ> yk = pconk + ik + gk + xk - mk

COMMENT> 
IDENTITY> sk
EQ> sk= pconk + ik + gk + xk

COMMENT> real government consumption
IDENTITY> gk
EQ> gk = g/pg

COMMENT> nominal export
IDENTITY> x
EQ> x = xk*px

COMMENT> 
IDENTITY> rer
EQ> rer = pc*xr/pf

COMMENT> 
BEHAVIORAL> XK_DS
EQ> TSDELTALOG(XK_DS) =  p_651 + p_652*TSDELTALOG(TSLAG(GDP_TP,4)) + p_653*TSDELTALOG(RER) + p_654*LOG(TSLAG(XK_DS,1)) + p_655*LOG(TSLAG(GDP_TP,1)) + p_657*D_2008Q2
COEFF> p_651 p_652 p_653 p_654 p_655 p_657
STORE> coe(7)

COMMENT> 
IDENTITY> xk
EQ> xk = xk_ds + p_172 + p_173*SD1 + p_174*SD2 + p_175*SD3 - mean_xk

COMMENT> nominal import
IDENTITY> m
EQ> m = mk*pm

COMMENT> 
BEHAVIORAL> MK_DS
EQ> TSDELTALOG(MK_DS) = p_661 + p_662*TSDELTALOG(TSLAG(MK_DS,2)) + p_663*TSDELTALOG(TSLAG(RER,1)) + p_664*TSDELTALOG(TSLAG(RER,3)) + p_665*TSDELTALOG(YK_DS) + p_666*LOG(TSLAG(MK_DS,1)) + p_667*LOG(TSLAG(YK_DS,1)) + p_668*D_20091 + p_669*D_2009Q4
COEFF> p_661 p_662 p_663 p_664 p_665 p_666 p_667 p_668 p_669
STORE> coe(8)

COMMENT> 
IDENTITY> mk
EQ> mk = mk_ds + p_180 + p_181*SD1 + p_182*SD2 + p_183*SD3 - mean_mk

COMMENT> GDP deflator
IDENTITY> py
EQ> py = y/yk

COMMENT> nominal sales
IDENTITY> s
EQ> s = pcon + g + i + x

COMMENT> wage bill paid by NFC
IDENTITY> w_nf
EQ> w_nf = w_h_r +  (W_row_r - W_row_p)

COMMENT> Gross operating surplus received by the NFC
IDENTITY> b2_nf_r
EQ> b2_nf_r = b2 - (b2_h_r + b2_f_r + b2_g_r)

COMMENT> 
IDENTITY> yf
EQ> yf = y-((p_tax+p_tax_row)-(p_sub+p_sub_row))

COMMENT> 
IDENTITY> b2
EQ> b2 = yf - w_nf

COMMENT> wage share
IDENTITY> ws
EQ> ws = w_nf/yf  * zz

COMMENT> profit share
IDENTITY> ps
EQ> ps = 1 - ws

COMMENT> Rate of capacity utilization
IDENTITY> u
EQ> u=yk/(bd_nfc_k+equip_nfc_k)

COMMENT> Profit rate
IDENTITY> prate
EQ> prate=s_nf/(TSLAG(bd_nfc,1)+TSLAG(equip_nfc,1))

COMMENT> 
IDENTITY> tobinq
EQ> tobinq = (eq_nf_l) / (equip_nfc + bd_nfc)

COMMENT> Er fixet
BEHAVIORAL> i_bd_nfc_k_ds
EQ> LOG(i_bd_nfc_k_ds) = p_800 + p_801*TSDELTALOG(TSLAG(i_bd_nfc_k_ds,1)/TSLAG(bd_nfc_k,2)) + p_802*TSDELTALOG(ps_ds) + p_803*TSDELTALOG(u_ds) + p_804* LOG(TSLAG(i_bd_nfc_k_ds,1)/TSLAG(bd_nfc_k,2)) + p_805 * LOG(TSLAG(ps_ds,1)) + p_806 * LOG(TSLAG(u_ds,1)) + alpha_1*TSLAG(LOG(i_bd_nfc_k_ds),1) + alpha_2*TSLAG(LOG(bd_nfc_k),1) + alpha_3*TSLAG(-LOG(bd_nfc_k),2)
COEFF> p_800 p_801 p_802 p_803 p_804 p_805 p_806 alpha_1 alpha_2 alpha_3
RESTRICT> alpha_1 = 1
alpha_2 = 1
alpha_3 = 1
STORE> coe(9)

COMMENT> 
IDENTITY> i_bd_nfc_k
EQ> i_bd_nfc_k = i_bd_nfc_k_ds + (p_156 + p_157*SD1 + p_158*SD2 + p_159*SD3) - mean_i_bd_nfc_k

COMMENT> 
IDENTITY> i_equip_nfc_k
EQ> i_equip_nfc_k = i_equip_nfc_k_ds + (p_164 + p_165*SD1 + p_166*SD2 + p_167*SD3) - mean_i_equip_nfc_k

COMMENT> 
IDENTITY> ik
EQ> ik =  i_equip_h_k + i_equip_nfc_k  +  i_equip_g_k + i_equip_fc_k +  i_bd_h_k + i_bd_nfc_k  +  i_bd_g_k  + i_bd_fc_k + i_adj_h_k + i_adj_nfc_k + i_adj_fc_k + i_adj_g_k

COMMENT> 
IDENTITY> i_h
EQ> i_h = i_equip_h_k*p_equip +  i_bd_h_k*p_bd  + i_adj_h_k*p_equip

COMMENT> 
IDENTITY> i_nf
EQ> i_nf = i_equip_nfc_k*p_equip +  i_bd_nfc_k*p_bd  + i_adj_nfc_k*p_equip

COMMENT> 
IDENTITY> i_f
EQ> i_f = i_equip_fc_k*p_equip +  i_bd_fc_k*p_bd  + i_adj_fc_k*p_equip 

COMMENT> 
IDENTITY> i_g
EQ> i_g = i_equip_g_k*p_equip +  i_bd_g_k*p_bd  + i_adj_g_k*p_equip

COMMENT> 
IDENTITY> i
EQ> i = i_nf + i_f + i_g + i_h 

COMMENT> 
BEHAVIORAL> i_equip_nfc_k_ds
EQ> LOG(i_equip_nfc_k_ds) = p_807 + p_808 * TSDELTALOG(TSLAG(i_equip_nfc_k_ds,1)/TSLAG(equip_nfc_k,2)) + p_809 * TSDELTALOG(ps_ds) + p_810 * TSDELTALOG(u_ds) + p_811 *  LOG(TSLAG(i_equip_nfc_k_ds,1)/TSLAG(equip_nfc_k,2)) + p_812 * LOG(TSLAG(ps_ds,1)) + p_813 * LOG(TSLAG(u_ds,1)) + p_814 * dummy_10 + p_815 * dummy_11 + p_890*TSDELTALOG(tobinq) + p_891*LOG(TSLAG(tobinq,1)) + alpha_1*TSLAG(LOG(i_equip_nfc_k_ds),1) + alpha_2*TSLAG(LOG(equip_nfc_k),1) + alpha_3*TSLAG(-LOG(equip_nfc_k),2)
COEFF> p_807 p_808 p_809 p_810 p_811 p_812 p_813 p_814 p_815 p_890 p_891 alpha_1 alpha_2 alpha_3
RESTRICT> alpha_1 = 1
alpha_2 = 1
alpha_3 = 1
STORE> coe(10)

COMMENT> 
IDENTITY> int_nf
EQ> int_nf = (TSLAG(idep,1)*TSLAG(iba_nf,1) + TSLAG(ibd,1)*TSLAG(sec_nf,1) + TSLAG(iloan,1)*TSLAG(l_nf,1)) 

COMMENT> 
IDENTITY> div_nf
EQ> div_nf =d_20124*((TSLAG(eq_nf_a_nf,1) + TSLAG(eq_nf_a_f,1) - (TSLAG(eq_nf_l_nf,1) + TSLAG(eq_h_nf,1)+ TSLAG(eq_row_a_nf,1) + TSLAG(eq_f_a_nf,1) + TSLAG(eq_g_nf,1)))* TSLAG(divd,1) + TSLAG(eq_nf_a_row,1)*TSLAG(diva,1)) + (1-d_20124)*(TSLAG(neq_nf,1)*TSLAG(divd,1)) + div_nf_adj 

COMMENT> 
IDENTITY> insu_nf
EQ> insu_nf =  TSLAG(ins_nf,1)*TSLAG(insu,1) 

COMMENT> 
IDENTITY> npropinc_nf
EQ> npropinc_nf = int_nf + int_nf_adj + div_nf + insu_nf + ins_nf_adj + (res_r_nf ) - (res_p_nf) 

COMMENT> gross income NFC
IDENTITY> yh_nf
EQ> yh_nf = y + B2_nf_r - B2 - (p_tax + p_tax_row) + (p_sub+p_sub_row) - w_nf + (npropinc_nf) 

COMMENT> savings NFC TAX_NF is negative
IDENTITY> s_nf
EQ> s_nf = yh_nf + Tax_nf + Oth_nf 

COMMENT> 
IDENTITY> tax_nf
EQ> tax_nf = -tax_rate_nf*y 

COMMENT> Sectoral balance NFC
IDENTITY> nl_nf
EQ> nl_nf = s_nf - i_nf - np_nf + ctr_nf


COMMENT> Financial side

COMMENT> Change in stocks

COMMENT> iba
IDENTITY> iba_nf
EQ> iba_nf = TSLAG(iba_nf,1) + iba_nf_tr + iba_nf_rvx 

COMMENT> 
IDENTITY> iba_nf_tr
EQ> iba_nf_tr = nl_nf + nl_nf_adj - neq_nf_tr - l_nf_tr - sec_nf_tr - ins_nf_tr

COMMENT> SEC . For the time being, we take sec_nf_tr as exogenous.
IDENTITY> sec_nf
EQ> sec_nf = TSLAG(sec_nf,1) + sec_nf_tr + sec_nf_rvx

COMMENT>  Loans
IDENTITY> l_nf
EQ> l_nf = TSLAG(l_nf,1) + l_nf_tr + l_nf_rvx

COMMENT> CHANGE in STOCKS OF EQUITIES:

COMMENT> Equities held as assets by NFC
IDENTITY> eq_nf_a
EQ> eq_nf_a = (1-d_20124)*(TSLAG(eq_nf_a,1) + eq_nf_a_tr + eq_nf_a_rvx)  + d_20124*eq_nf_ax 


COMMENT> 
IDENTITY> eq_nf_a_nf
EQ> eq_nf_a_nf = d_20124 * (TSLAG(eq_nf_a_nf,1) + eq_nf_a_nf_tr + eq_nf_a_nf_rv)

COMMENT> equiteies NFC-NFC asset is obviously equal to equities NFC-NFC liability
IDENTITY> eq_nf_l_nf
EQ> eq_nf_l_nf = eq_nf_a_nf

COMMENT> this is the data for quities as assets for NFC viz-a-viz counter parties, e.g., NFC purchase equities from NFC, FC, and RoW
IDENTITY> eq_nf_ax
EQ> eq_nf_ax =  eq_nf_a_nf + eq_nf_a_f + eq_nf_a_row

COMMENT> 
IDENTITY> eq_nf_a_f
EQ> eq_nf_a_f = d_20124 * (TSLAG(eq_nf_a_f,1) + eq_nf_a_f_tr + eq_nf_a_f_rv)

COMMENT> 
IDENTITY> eq_nf_a_row
EQ> eq_nf_a_row = d_20124 * (TSLAG(eq_nf_a_row,1) + eq_nf_a_row_tr + eq_nf_a_row_rv)

COMMENT> total gross liabilities of equities on firms balance sheet is defined as the sum of NFC-NFC asset + the sum of NFC equities held by other sectors
IDENTITY> eq_nf_l
EQ> eq_nf_l = (1- d_20124)*(TSLAG(eq_nf_l,1) + eq_nf_l_tr + eq_nf_l_rvx)   +  d_20124*eq_nf_lx

COMMENT> 
IDENTITY> neq_nf
EQ> neq_nf =d_20123*(-alpha_neq_nf * i_nf) + d_20124*( (eq_nf_a_f+ eq_nf_a_row)-(eq_f_a_nf + eq_g_nf + eq_h_nf + eq_row_a_nf))

COMMENT> 
IDENTITY> neq_nf_tr
EQ> neq_nf_tr = TSDELTA(neq_nf)-(neq_nf_rvx)


COMMENT>Some consistency check eqs:



COMMENT> this variable should be zero after 2012 and onwards as it captures the difference between equities as assets for nfc (aggregate) data minus equities as assets for NFC held at difference sectors after 2012. In short, after 2012, we can identify the counter parties where NFC are holding stocks.
IDENTITY> eq_nf_a_test
EQ> eq_nf_a_test = eq_nf_a - eq_nf_ax

COMMENT> this variable should be zero after 2012 and onwards as it captures the difference between equities as liabilities for nfc (aggregate) data minus equities as liabilities for NFC held at difference sectors after 2012. 
IDENTITY> eq_nf_l_test
EQ> eq_nf_l_test = eq_nf_l - eq_nf_lx 

COMMENT> insurance NFC
IDENTITY> ins_nf
EQ> ins_nf = TSLAG(ins_nf,1) + ins_nf_tr + ins_nf_rvx 

COMMENT> FINANCIAL NET WEALTH

COMMENT> net financial wealth
IDENTITY> fnw_nf
EQ> fnw_nf = iba_nf + EQ_nf_a - EQ_nf_l + sec_nf + L_nf + INS_nf 

COMMENT> 
IDENTITY> fnw_nfk
EQ> fnw_nfk = fnw_nf/pc

COMMENT> Capital Account


COMMENT> gross fixed capital formation (buildings and dwellings)
IDENTITY> i_bd_nfc
EQ> i_bd_nfc = i_bd_nfc_k * p_bd

COMMENT> 
IDENTITY> i_equip_nfc
EQ> i_equip_nfc = i_equip_nfc_k * p_equip 

COMMENT>  Real net stock of buildings and dwellings
IDENTITY> bd_nfc_k
EQ> TSDELTA(bd_nfc_k) = i_bd_nfc_k - TSLAG(bd_nfc_k,1) * delta_bd_nfc

COMMENT> Real net stock of equipment
IDENTITY> equip_nfc_k
EQ> TSDELTA(equip_nfc_k) = i_equip_nfc_k - TSLAG(equip_nfc_k,1) * delta_equip_nfc 

COMMENT> Nominal net stock of buildings and dwellings
IDENTITY> bd_nfc
EQ> TSDELTA(bd_nfc) = i_bd_nfc + TSLAG(bd_nfc_k,1) * (1-delta_bd_nfc)*TSDELTA(p_bd) - TSLAG(bd_nfc_k,1) * delta_bd_nfc * p_bd 

COMMENT> Nominal net stock of equipment
IDENTITY> equip_nfc
EQ> TSDELTA(equip_nfc) = i_equip_nfc + TSLAG(equip_nfc_k,1) * (1-delta_equip_nfc)*TSDELTA(p_equip) - TSLAG(equip_nfc_k,1) * delta_equip_nfc * p_equip 

COMMENT> FINANCIAL CORP

COMMENT> Real side

COMMENT> 
IDENTITY> int_f
EQ> int_f = (TSLAG(idep,1)*TSLAG(iba_f,1) + TSLAG(iloan,1)*TSLAG(l_f,1) + TSLAG(ibd,1)*TSLAG(sec_f_d,1) + TSLAG(iboa,1)*TSLAG(sec_f_a,1)) 

COMMENT> 
IDENTITY> div_f
EQ> div_f = d_20124 *(((TSLAG(eq_f_a_f,1) + TSLAG(eq_f_a_nf,1)) - (TSLAG(eq_f_l_f,1) + TSLAG(eq_h_f ,1)+ TSLAG(eq_row_a_f,1) + TSLAG(eq_nf_a_f,1) + TSLAG(eq_g_f,1)))* TSLAG(divd,1) + TSLAG(eq_f_a_row,1)*TSLAG(diva,1)) + (1-d_20124)*((TSLAG(neq_f,1)*TSLAG(divd,1))) +  div_f_adj 

COMMENT> 
IDENTITY> insu_f
EQ> insu_f = TSLAG(ins_f,1)*TSLAG(insu,1)

COMMENT> 
IDENTITY> propinc_r_f
EQ> propinc_r_f = int_r_f + div_r_f + ins_r_f + res_r_f

COMMENT> 
IDENTITY> propinc_p_f
EQ> propinc_p_f = int_p_f + div_p_f + ins_p_f + res_p_f

COMMENT> 
IDENTITY> npropinc_f
EQ> npropinc_f = int_f + int_f_adj +  div_f + insu_f + ins_f_adj + (res_r_f) - (res_p_f)

COMMENT> 
IDENTITY> yh_f
EQ> yh_f = B2_f_r + (npropinc_f )

COMMENT> 
IDENTITY> yd_f
EQ> yd_f = Yh_f + Tax_f + nben_f + Oth_f

COMMENT> This is based on the fact that d8_h = d8_f in the data.
IDENTITY> d8_f
EQ> d8_f = d8_h

COMMENT> 
IDENTITY> nben_f
EQ> nben_f = d8_f 

COMMENT> Savings F
IDENTITY> s_f
EQ> s_f = Yd_f - D8_f

COMMENT> Sectoral balance F
IDENTITY> nl_f
EQ> nl_f = s_f - i_f - np_f + ctr_f

COMMENT> FInancial side

COMMENT> Change in stocks of ibas

COMMENT> 
IDENTITY> iba_f
EQ>  iba_f = TSLAG(iba_f,1) + iba_f_tr + iba_f_rvx

COMMENT> 
IDENTITY> iba_f_tr
EQ> iba_f_tr = -(iba_nf_tr + iba_h_tr + iba_g_tr + iba_row_tr)

COMMENT> Change in stocks of equities:

COMMENT> 
IDENTITY> eq_f_a
EQ> eq_f_a = (1-d_20124)*(TSLAG(eq_f_a,1) + eq_f_a_tr + eq_f_a_rvx)  + d_20124*eq_f_ax

COMMENT> 
IDENTITY> eq_f_a_nf
EQ> eq_f_a_nf = d_20124 * (TSLAG(eq_f_a_nf,1) + eq_f_a_nf_tr + eq_f_a_nf_rv)

COMMENT> 
IDENTITY> eq_f_a_f
EQ> eq_f_a_f = d_20124 * (TSLAG(eq_f_a_f,1) + eq_f_a_f_tr + eq_f_a_f_rv)

COMMENT> 
IDENTITY> eq_f_l_f
EQ> eq_f_l_f = eq_f_a_f 

COMMENT> 
IDENTITY> eq_f_a_row
EQ> eq_f_a_row = d_20124 * (TSLAG(eq_f_a_row,1) + eq_f_a_row_tr + eq_f_a_row_rv)

COMMENT> this is the data for quities as assets for NFC viz-a-viz counter parties, e.g., NFC purchase equities from NFC, FC, and RoW
IDENTITY> eq_f_ax
EQ> eq_f_ax =  eq_f_a_nf + eq_f_a_f + eq_f_a_row

COMMENT> 
IDENTITY> eq_f_l
EQ> eq_f_l = (1- d_20124)*(TSLAG(eq_f_l,1) + eq_f_l_tr + eq_f_l_rvx)   +  d_20124*eq_f_lx 

COMMENT> 
IDENTITY> eq_f_lx
EQ> eq_f_lx =   eq_nf_a_f + eq_h_f + eq_row_a_f + eq_f_a_f + eq_g_f 

COMMENT> 
IDENTITY> neq_f
EQ> neq_f = eq_f_A - eq_f_L

COMMENT> 
IDENTITY> neq_f_tr
EQ> neq_f_tr = TSDELTA(neq_f) - neq_f_rvx

COMMENT> 
IDENTITY> eq_f_l_test
EQ> eq_f_l_test = eq_f_l - (eq_f_l_f + eq_h_f + eq_row_a_f + eq_nf_a_f + eq_g_f)

COMMENT> Change in stocks of securities

COMMENT> 
IDENTITY> sec_f_d
EQ> sec_f_d = TSLAG(sec_f_d,1) + sec_f_d_tr + sec_f_d_rvx

COMMENT> 
IDENTITY> sec_f_d_tr
EQ> sec_f_d_tr =  nl_f + nl_f_adj - iba_f_tr - ins_f_tr - l_f_tr - neq_f_tr - sec_f_a_tr

COMMENT> 
IDENTITY> sec_f_d_tr_nf
EQ> sec_f_d_tr_nf=-sec_nf_tr

COMMENT> 
IDENTITY> sec_f_d_tr_g
EQ> sec_f_d_tr_g=sec_f_d_tr-sec_f_d_tr_nf

COMMENT> 
IDENTITY> sec_f_a
EQ> sec_f_a = TSLAG(sec_f_a,1) + sec_f_a_tr + sec_f_a_rvx

COMMENT> 
IDENTITY> sec_f_a_tr
EQ> sec_f_a_tr=-sec_row_tr

COMMENT> 
IDENTITY> l_f
EQ> l_f = -(l_h + l_nf + l_g + l_row)

COMMENT> 
IDENTITY> l_f_tr
EQ> l_f_tr = TSDELTA(l_f) - L_f_rvx

COMMENT> 
IDENTITY> ins_f
EQ> ins_f = -(ins_h + ins_row + ins_nf + ins_g)

COMMENT> 
IDENTITY> ins_f_tr
EQ> ins_f_tr = TSDELTA(ins_f) - ins_f_rvx

COMMENT> 'WEALTH

COMMENT> 
IDENTITY> fnw_f
EQ> fnw_f = iba_f + sec_f_a + sec_f_d + L_f + eq_f_a - eq_f_l + ins_f

COMMENT> 
IDENTITY> fnw_fk
EQ> fnw_fk = fnw_f/pc

COMMENT> Capital Account

COMMENT> gross fixed capital formation (buildings and dwellings)
IDENTITY> i_bd_fc
EQ> i_bd_fc = i_bd_fc_k * p_bd

COMMENT> gross fixed capital formation (equipment)
IDENTITY> i_equip_fc
EQ> i_equip_fc = i_equip_fc_k * p_equip

COMMENT> 
IDENTITY> bd_fc_k
EQ> TSDELTA(bd_fc_k) = i_bd_fc_k - TSLAG(bd_fc_k,1) * delta_bd_fc

COMMENT> 
IDENTITY> equip_fc_k
EQ> TSDELTA(equip_fc_k) = i_equip_fc_k - TSLAG(equip_fc_k,1) * delta_equip_fc

COMMENT> 
IDENTITY> bd_fc
EQ> TSDELTA(bd_fc) = i_bd_fc + TSLAG(bd_fc_k,1) * (1-delta_bd_fc)*TSDELTA(p_bd) - TSLAG(bd_fc_k,1) * delta_bd_fc * p_bd

COMMENT> 
IDENTITY> equip_fc
EQ> TSDELTA(equip_fc) = i_equip_fc + TSLAG(equip_fc_k,1) * (1-delta_equip_fc)*TSDELTA(p_equip) - TSLAG(equip_fc_k,1) * delta_equip_fc * p_equip

COMMENT> GOVT 

COMMENT> Real side 

COMMENT> 
IDENTITY> int_g
EQ> int_g = (TSLAG(idep,1)*TSLAG(iba_g,1) + TSLAG(iloan,1)*TSLAG(l_g,1) + TSLAG(ibd,1)*TSLAG(sec_g,1))

COMMENT> 
IDENTITY> div_g
EQ> div_g = d_20124 * ( (TSLAG(eq_g_nf,1) + TSLAG(eq_g_f,1))*TSLAG(divd,1) + TSLAG(eq_g_row,1)*TSLAG(diva,1) ) + (1-d_20124) * ((TSLAG(eq_g,1)*TSLAG(divd,1))) + div_g_adj

COMMENT> 
IDENTITY> insu_g
EQ> insu_g = TSLAG(ins_g,1)*TSLAG(insu,1)

COMMENT> 
IDENTITY> propinc_r_g
EQ> propinc_r_g = int_r_g + div_r_g + res_r_g

COMMENT> 
IDENTITY> propinc_p_g
EQ> propinc_p_g = int_p_g + res_p_g

COMMENT> 
IDENTITY> npropinc_g
EQ> npropinc_g = int_g + int_g_adj + div_g + insu_g + ins_g_adj + (res_r_g) - ( res_p_g)

COMMENT> 
IDENTITY> Yh_g
EQ> Yh_g = B2_g_r + p_tax - p_sub + (npropinc_g)

COMMENT> 
IDENTITY> Yd_g
EQ> Yd_g = Yh_g + tax_g + nben_g + Oth_g

COMMENT> 
IDENTITY> nben_g
EQ> nben_g = - (nben_row + nsben_h + nben_f)

COMMENT> 
IDENTITY> tax_g
EQ> tax_g = -(tax_h + tax_nf + tax_f + tax_row)

COMMENT> 
IDENTITY> s_g
EQ> s_g = Yd_g - G

COMMENT> 
IDENTITY> nl_g
EQ> nl_g = s_g - i_g - np_g + ctr_g

COMMENT> Financial side

COMMENT> Change in stocks ' we need to have an accomodating asset

COMMENT> 
IDENTITY> iba_g
EQ> iba_g= TSLAG(iba_g,1) + iba_g_tr + iba_g_rvx

COMMENT> 
IDENTITY> eq_g
EQ> eq_g = (1-d_20124)*(TSLAG(eq_g,1) + eq_g_tr + eq_g_rvx) + d_20124*eq_g_ax

COMMENT> 
IDENTITY> eq_g_nf
EQ> eq_g_nf = d_20124 * (TSLAG(eq_g_nf,1) + eq_g_nf_tr + eq_g_nf_rv)

COMMENT> 
IDENTITY> eq_g_f
EQ> eq_g_f = d_20124 * (TSLAG(eq_g_f,1) + eq_g_f_tr + eq_g_f_rv)

COMMENT> 
IDENTITY> eq_g_row
EQ> eq_g_row = d_20124 * (TSLAG(eq_g_row,1) + eq_g_row_tr + eq_g_row_rv)

COMMENT> 
IDENTITY> eq_g_ax
EQ> eq_g_ax =  eq_g_row + eq_g_f + eq_g_nf

COMMENT> 
IDENTITY> eq_g_test
EQ> eq_g_test = eq_g - (eq_g_nf + eq_g_f + eq_g_row)

COMMENT> 
IDENTITY> sec_g
EQ> sec_g = TSLAG(sec_g,1) + sec_g_tr + sec_g_rvx

COMMENT> 
IDENTITY> sec_g_tr
EQ> sec_g_tr = nl_g + nl_g_adj - iba_g_tr - l_g_tr - eq_g_tr - ins_g_tr

COMMENT> SKAL REDDUNDANT EQ MED HER???? redundant = (sec_g_tr_0+(sec_h_tr_g_0+sec_f_d_tr_g_0))  'Redundant equation

COMMENT> 
IDENTITY> l_g
EQ> l_g = TSLAG(l_g,1) + l_g_tr + l_g_rvx

COMMENT> 
IDENTITY> ins_g
EQ> ins_g = TSLAG(ins_g,1) + ins_g_tr + ins_g_rvx

COMMENT> WEALTH

COMMENT> 
IDENTITY> fnw_g
EQ> fnw_g = Iba_g + eq_g + sec_g + L_g + ins_g

COMMENT> 
IDENTITY> fnw_gk
EQ> fnw_gk = fnw_g/pc

COMMENT> Capital Account

COMMENT> gross fixed capital formation (buildings and dwellings)
IDENTITY> i_bd_g
EQ> i_bd_g = i_bd_g_k * p_bd

COMMENT> gross fixed capital formation (equipment)
IDENTITY> i_equip_g
EQ> i_equip_g = i_equip_g_k * p_equip

COMMENT> Real net stock of buildings and dwellings
IDENTITY> bd_g_k
EQ> TSDELTA(bd_g_k) = i_bd_g_k - TSLAG(bd_g_k,1) * delta_bd_g

COMMENT> 
IDENTITY> equip_g_k
EQ> TSDELTA(equip_g_k) = i_equip_g_k - TSLAG(equip_g_k,1) * delta_equip_g

COMMENT> 
IDENTITY> bd_g
EQ> TSDELTA(bd_g) = i_bd_g + TSLAG(bd_g_k,1) * (1-delta_bd_g)*TSDELTA(p_bd) - TSLAG(bd_g_k,1) * delta_bd_g * p_bd 

COMMENT> 
IDENTITY> equip_g
EQ> TSDELTA(equip_g) = i_equip_g + TSLAG(equip_g_k,1) * (1-delta_equip_g)*TSDELTA(p_equip) - TSLAG(equip_g_k,1) * delta_equip_g * p_equip

COMMENT> REST OF THE WORLD

COMMENT> Real side

COMMENT> 
IDENTITY> int_row
EQ> int_row = (TSLAG(idep,1)*TSLAG(iba_row,1) + TSLAG(iboa,1)*TSLAG(sec_row,1) + TSLAG(iloan,1)*TSLAG(l_row,1))

COMMENT> 
IDENTITY> div_row
EQ> div_row = d_20124*(  (TSLAG(eq_row_a_nf,1) + TSLAG(eq_row_a_f,1))*TSLAG(divd,1) - ((TSLAG(eq_nf_a_row,1)+TSLAG(eq_f_a_row,1)+TSLAG(eq_g_row,1)+TSLAG(eq_h_row,1))*TSLAG(diva,1))) + (1-d_20124) * ((TSLAG(neq_row,1)*TSLAG(divd,1))) + div_row_adj 

COMMENT> 
IDENTITY> insu_row
EQ> insu_row = TSLAG(ins_row,1)*TSLAG(insu,1)

COMMENT> 
IDENTITY> propinc_r_row
EQ> propinc_r_row = int_r_row + div_r_row + ins_r_row + res_r_row

COMMENT> 
IDENTITY> propinc_p_row
EQ> propinc_p_row = int_p_row + div_p_row + ins_p_row + res_p_row

COMMENT> 
IDENTITY> npropinc_row
EQ> npropinc_row = int_row + int_row_adj + div_row + insu_row + ins_row_adj + (res_r_row) - (res_p_row)

COMMENT> 
IDENTITY> s_row
EQ> s_row = M - X + p_tax_row - p_sub_row + (W_row_r - W_row_p) +  (npropinc_row) + (Tax_row) + nben_row + Oth_row

COMMENT> 
IDENTITY> nl_row
EQ> nl_row = s_row + Ctr_row - NP_row

COMMENT> 
IDENTITY> nben_row
EQ> nben_row = Scon_row_r - Scon_row_p + Sben_row_r - Sben_row_p

COMMENT> 
IDENTITY> nx
EQ> nx = x - m

COMMENT> 
IDENTITY> cab
EQ> cab =-nl_row

COMMENT> 
IDENTITY> bop
EQ> bop = cab + fab

COMMENT> 
IDENTITY> fab
EQ> fab = (fnl_row)

COMMENT> Financial side

COMMENT> 
IDENTITY> iba_row
EQ> iba_row= TSLAG(iba_row,1) + iba_row_tr + iba_row_rvx

COMMENT> 
IDENTITY> iba_row_tr
EQ> iba_row_tr = NL_row + nl_row_adj - neq_row_tr - sec_row_tr - L_row_tr - ins_row_tr 

COMMENT> 
IDENTITY> sec_row
EQ> sec_row = TSLAG(sec_row,1) + sec_row_tr + sec_row_rvx

COMMENT> 
IDENTITY> L_row
EQ> L_row = TSLAG(L_row,1) + L_row_tr + L_row_rvx

COMMENT> CHANGE in equities

COMMENT> 
IDENTITY> eq_row_a
EQ> eq_row_a = (1-d_20124)*(TSLAG(eq_row_a,1) + eq_row_a_tr + eq_row_a_rvx)  + d_20124*eq_row_ax

COMMENT> 
IDENTITY> eq_row_a_nf
EQ> eq_row_a_nf = d_20124 * (TSLAG(eq_row_a_nf,1) + eq_row_a_nf_tr + eq_row_a_nf_rv)

COMMENT> 
IDENTITY> eq_row_a_f
EQ> eq_row_a_f = d_20124 * (TSLAG(eq_row_a_f,1) + eq_row_a_f_tr + eq_row_a_f_rv)

COMMENT> 
IDENTITY> eq_row_ax
EQ> eq_row_ax =  eq_row_a_nf + eq_row_a_f

COMMENT> 
IDENTITY> eq_row_a_test
EQ> eq_row_a_test = eq_row_a - (eq_row_a_nf + eq_row_a_f)

COMMENT> 
IDENTITY> eq_row_L
EQ> eq_row_L = (1-d_20124)*(TSLAG(eq_row_l,1) + eq_row_l_tr + eq_row_l_rvx) + d_20124*(eq_row_lx)

COMMENT> 
IDENTITY> eq_row_lx
EQ> eq_row_lx = eq_nf_a_row + eq_h_row + eq_f_a_row + eq_g_row

COMMENT> 
IDENTITY> eq_row_l_test
EQ> eq_row_l_test = eq_row_l - (eq_nf_a_row + eq_f_a_row + eq_g_row + eq_h_row)

COMMENT> 
IDENTITY> neq_row
EQ> neq_row =-d_20123*(neq_nf + eq_h + neq_f + eq_g) + d_20124*( eq_row_a_nf + eq_row_a_f - (eq_nf_a_row + eq_f_a_row + eq_g_row + eq_h_row))

COMMENT> 
IDENTITY> neq_row_tr
EQ> neq_row_tr = TSDELTA(neq_row) - neq_row_rvx

COMMENT> 
IDENTITY> ins_row
EQ> ins_row = TSLAG(ins_row,1) + ins_row_tr + ins_row_rvx

COMMENT> WEALTH

COMMENT> 
IDENTITY> fnw_row
EQ> fnw_row = iba_row + EQ_row_A - EQ_row_L + sec_row + L_row + INS_row

COMMENT> 
IDENTITY> fnw_rowk
EQ> fnw_rowk = fnw_row/pc

COMMENT> Labour market

COMMENT> 
IDENTITY> UNadj
EQ> UNadj = LF - EMPadj

COMMENT> 
IDENTITY> UNEMP
EQ> UNEMP = LF - EMP

COMMENT> 
IDENTITY> UR
EQ> UR = UNEMP/LF

COMMENT> 
IDENTITY> URadj
EQ> URadj = UNadj/LF

COMMENT> 
IDENTITY> LF
EQ> LF = (part*pop)/1000


COMMENT> The pricing equation implies a mark-up of (1 + 0.38) in the long-run, i.e., the long-run (co-integrating vector) impact of the indepenent variable on pc_ds = 0.029/0.021

COMMENT> 
BEHAVIORAL> pc_ds
EQ> TSDELTA(pc_ds) = C_21*TSDELTA(TSLAG(pc_ds,1)) + C_22*TSDELTA(TSLAG(pc_ds,2)) + C_23*TSDELTA(TSLAG(pc_ds,4)) + C_24*TSDELTA(wage_ds/prod_ds+pm_ds) + C_25*TSLAG(pc_ds,1) + eta*(TSLAG(wage_ds,1)/TSLAG(prod_ds,1)+TSLAG(pm_ds,1))
COEFF> C_21 C_22 C_23 C_24 C_25 eta
STORE> coe(11)

COMMENT> 
IDENTITY> pc
EQ> pc = pc_ds + p_108 + p_109*SD1 + p_110*SD2 + p_111*SD3 - mean_pc

COMMENT> 
IDENTITY> mkp
EQ> mkp = pc_ds / (wage_ds/prodk_ds + pm_ds)

COMMENT> Behavoural???
IDENTITY> emp
EQ> emp = p_250 * (yk/prodk)

COMMENT> 
IDENTITY> urterm
EQ> urterm = ur - urs

COMMENT> 
BEHAVIORAL> rw_ds
EQ> TSDELTALOG(rw_ds) = phi + p_521*TSDELTA(TSLAG(ur,4)) + p_522*TSDELTA(LOG(prodk_ds)) + p_523*LOG(TSLAG(rw_ds,1)) + p_524*TSLAG(ur_ds,2) + p_525*LOG(TSLAG(prodk_ds,2)) + p_526*D_2009Q4 + p_527*D_2011Q1
COEFF> phi p_521 p_522 p_523 p_524 p_525 p_526 p_527 
STORE> coe(12)

COMMENT> 
IDENTITY> wage
EQ> wage = wage_ds  + (p_120 + p_121*SD1 + p_122*SD2 + p_123*SD3) - mean_wage

COMMENT>  Jeg laver nok bare en tidsserie fra 2010q3
IDENTITY> wageindex
EQ> wageindex = wage/wage_2010q3

COMMENT> 
IDENTITY> mkp
EQ> mkp = pc_ds / (wage_ds/prodk_ds + pm_ds)

COMMENT> 
IDENTITY> wage_ds
EQ> wage_ds = rw_ds*pc_ds

COMMENT> 
IDENTITY> prod
EQ> prod=prodk * (y/yk)

COMMENT> 
IDENTITY> prod_ds
EQ> prod_ds=prodk_ds * (y_ds/yk_ds)

COMMENT> 
IDENTITY> acc_rate
EQ> acc_rate = ik / (bd_h_k+equip_h_k+bd_nfc_k+equip_nfc_k+bd_fc_k+equip_fc_k+bd_g_k+equip_g_k)

END"
```


# Noter til model

Jeg forsøger at estimere seasonality i modellen? Eller skal jeg forsøge uden for modellen først

- Ved ik om jeg kan få den til at tage mean oppe i modellen, hvis ikke skal mean laves som en exogen variable nede ved tidsserierne. 




```{r}
options(scipen = 999)


S_model=LOAD_MODEL(modelText = S_model.txt)
```



```{r}

# I think I should create the timeseries for the coeff. 

S_modelData=list(  
  y  = TIMESERIES(c(y),   
                  START=c(2005,2),FREQ=4),
  pcon  = TIMESERIES(c(pcon),   
                     START=c(2005,2),FREQ=4),
  g = TIMESERIES(c(g),   
                  START=c(2005,2),FREQ=4),
  yh_h = TIMESERIES(c(yh_h),   
                  START=c(2005,2),FREQ=4),
  b2_h_r = TIMESERIES(c(b2_h_r),   
                  START=c(2005,2),FREQ=4),
  pcon_ds = TIMESERIES(c(pcon_ds),   
                  START=c(2005,2),FREQ=4),
  sd1 = TIMESERIES(c(sd1),   
                  START=c(2005,2),FREQ=4),
  sd2 = TIMESERIES(c(sd2),   
                  START=c(2005,2),FREQ=4),
  sd3 = TIMESERIES(c(sd3),   
                  START=c(2005,2),FREQ=4),
  D_2008Q4 = TIMESERIES(c(d_2008q4),   
                  START=c(2005,2),FREQ=4),
  PCON_ds = TIMESERIES(c(pcon_ds),   
                  START=c(2005,2),FREQ=4),
  alpha_1 = TIMESERIES(c(alpha_1),   
                  START=c(2005,2),FREQ=4),
  alpha_2 = TIMESERIES(c(alpha_2),   
                  START=c(2005,2),FREQ=4),
  alpha_3 = TIMESERIES(c(alpha_3),   
                  START=c(2005,2),FREQ=4),
  mean_pcon = TIMESERIES(c(mean_pcon),   
                  START=c(2005,2),FREQ=4)
)


S_model=LOAD_MODEL_DATA(S_model,S_modelData)
```


```{r}
#Estimate model coefficients
S_model=ESTIMATE(S_model
                 ,TSRANGE=c(2005,4,2020,1)
                 ,forceTSRANGE = TRUE
)
```

```{r}
# In-sample prediction (no add factors)
S_model <- SIMULATE(S_model
                    ,simType='STATIC'
                    ,TSRANGE=c(2005,4,2020,1)
                    ,simConvergence=0.00001
                    ,simIterLimit=100
                   )
```
```{r}
y_00 = S_model$simulation$y
pcon_00 = S_model$simulation$pcon
pcon_ds_00 = S_model$simulation$PCON_ds


```

```{r}
plot(pcon_00)
plot(pcon_ds)
```

# Shocks

## Scenario 1

We create a shock to the deseasonalized consumption of -10000

```{r}

# Define add-factor list (defining shock)
constantAdjList <- list(
  
  pcon_ds = TIMESERIES(-10000,START=c(2010,1), END=c(2010,1),  FREQ='Q')

)

```


```{r}
# Simulate the model (following shock)
S_model <- SIMULATE(S_model
                    ,simType='DYNAMIC'
                    ,TSRANGE=c(2005,4,2020,1)
                    ,simConvergence=0.00001
                    ,simIterLimit=100
                    ,ConstantAdjustment=constantAdjList
                    ,quietly=TRUE)
```


```{r}
pcon_ds_1 = S_model$simulation$pcon_ds
pcon_1 = S_model$simulation$pcon
```

```{r}
plot(pcon_ds_1)
plot(pcon_1)
```
